# Week 2 Day 3-4: è‡ªå‹•ãƒªãƒ©ã‚¤ãƒˆæ©Ÿèƒ½ è¨­è¨ˆæ›¸

## ğŸ¯ ç›®çš„

èªå½™é•åã‚’æ¤œå‡ºã—ãŸå•é¡Œã‚’ã€è‡ªå‹•çš„ã«A1èªå½™ã«ç½®ãæ›ãˆã¦ä¿®æ­£ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã€å•é¡Œç”Ÿæˆã®æˆåŠŸç‡ã‚’ã•ã‚‰ã«å‘ä¸Šã•ã›ã‚‹ã€‚

## ğŸ“Š ç¾çŠ¶ã®èª²é¡Œ

### Week 2 Day 1-2 å®Œäº†æ™‚ç‚¹
- Few-shot exampleså°å…¥ã«ã‚ˆã‚Šèªå½™é•åç‡ã¯æ”¹å–„è¦‹è¾¼ã¿ï¼ˆ30-40% â†’ <10%ç›®æ¨™ï¼‰
- ã—ã‹ã—ã€ã¾ã 10%ç¨‹åº¦ã®é•åãŒæ®‹ã‚‹å¯èƒ½æ€§
- é•åã—ãŸå•é¡Œã¯å˜ç´”ã«å´ä¸‹ã•ã‚Œã‚‹ï¼ˆç„¡é§„ï¼‰

### è§£æ±ºã™ã¹ãå•é¡Œ
1. **ç”Ÿæˆã‚³ã‚¹ãƒˆã®ç„¡é§„**: é•åã—ãŸå•é¡Œã‚’æ¨ã¦ã‚‹ã®ã¯ã‚‚ã£ãŸã„ãªã„
2. **è©¦è¡Œå›æ•°ã®å¢—åŠ **: å†ç”Ÿæˆã«ã¯è¿½åŠ ã®APIå‘¼ã³å‡ºã—ã¨ã‚³ã‚¹ãƒˆãŒå¿…è¦
3. **æ™‚é–“çš„ã‚³ã‚¹ãƒˆ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¾…ã¤æ™‚é–“ãŒé•·ããªã‚‹

## ğŸš€ ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³: è‡ªå‹•ãƒªãƒ©ã‚¤ãƒˆæ©Ÿèƒ½

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Question Generation (GPT-4o)                               â”‚
â”‚  - Few-shot promptsé©ç”¨æ¸ˆã¿                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vocabulary Validation (æ—¢å­˜)                               â”‚
â”‚  - 2,518 A1èªå½™ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ãƒã‚§ãƒƒã‚¯                         â”‚
â”‚  - é•åå˜èªãƒªã‚¹ãƒˆæŠ½å‡º                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
                    é•åã‚ã‚Šï¼Ÿ
                    /        \
                  YES         NO
                   â†“           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Auto-Rewrite (NEW!)            â”‚    â”‚  Accept Question â”‚
â”‚  - GPT-4oã§è‡ªå‹•ãƒªãƒ©ã‚¤ãƒˆ          â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  - é•åå˜èªã‚’A1èªå½™ã«ç½®æ›        â”‚
â”‚  - æ–‡æ³•ãƒ»æ„å‘³ã‚’ä¿æŒ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Re-validation                                              â”‚
â”‚  - ãƒªãƒ©ã‚¤ãƒˆå¾Œã®å•é¡Œã‚’å†æ¤œè¨¼                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
                    ã¾ã é•åï¼Ÿ
                    /        \
                  YES         NO
                   â†“           â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Reject  â”‚   â”‚  Accept Question â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

| æŒ‡æ¨™ | Before | After (Rewriteé©ç”¨) | æ”¹å–„ |
|------|--------|-------------------|------|
| èªå½™é•åå´ä¸‹ç‡ | <10% | **<2%** | 80%æ¸› |
| ç”ŸæˆæˆåŠŸç‡ | >90% | **>98%** | 8%å¢— |
| è©¦è¡Œå›æ•°/å•é¡Œ | 1.2å› | **1.05å›** | 12%æ¸› |
| APIå‘¼ã³å‡ºã— | 1.2å› | **1.1å›** (rewriteå«ã‚€) | 8%æ¸› |

## ğŸ“ å®Ÿè£…è¨ˆç”»

### Phase 1: Rewrite Promptè¨­è¨ˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/eiken/prompts/rewrite-prompts.ts`

```typescript
export interface RewriteRequest {
  originalQuestion: string;
  originalChoices: string[];
  violatedWords: string[];
  targetLevel: string;
  grammarPoint?: string;
}

export interface RewriteResult {
  rewrittenQuestion: string;
  rewrittenChoices: string[];
  correctAnswerIndex: number;
  replacements: {
    original: string;
    replacement: string;
    reason: string;
  }[];
  confidence: number; // 0.0-1.0
}

export function buildRewritePrompt(request: RewriteRequest): string {
  return `
You are an expert at rewriting English test questions to use simpler vocabulary.

TASK: Rewrite the following question to use ONLY A1 (beginner) level vocabulary.

ORIGINAL QUESTION:
"${request.originalQuestion}"

CHOICES:
${request.originalChoices.map((c, i) => `${i + 1}. ${c}`).join('\n')}

VIOLATED WORDS (must be replaced):
${request.violatedWords.join(', ')}

REQUIREMENTS:
1. Replace all violated words with A1 vocabulary equivalents
2. Keep the same grammar structure and difficulty
3. Preserve the meaning and testing point
4. Maintain naturalness and clarity
5. Keep choices parallel in structure
6. Ensure only ONE correct answer

ALLOWED A1 VOCABULARY:
Verbs: be, have, go, come, make, take, get, do, see, want, ...
Nouns: time, day, school, home, friend, family, book, ...
Adjectives: good, bad, big, small, happy, sad, old, new, ...

EXAMPLES:
âŒ "She was delighted to receive the promotion."
âœ… "She was happy to get the good news."

âŒ "The conference will commence next week."
âœ… "The party will start next week."

Return JSON:
{
  "rewritten_question": "...",
  "rewritten_choices": ["...", "...", "...", "..."],
  "correct_answer_index": 0-3,
  "replacements": [
    {
      "original": "delighted",
      "replacement": "happy",
      "reason": "simpler A1 adjective"
    }
  ],
  "confidence": 0.0-1.0
}
`;
}
```

### Phase 2: Vocabulary Rewriter Service

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/eiken/services/vocabulary-rewriter.ts`

```typescript
import type { EikenEnv } from '../types';
import type { VocabularyViolation } from '../types/vocabulary';
import { buildRewritePrompt, type RewriteRequest, type RewriteResult } from '../prompts/rewrite-prompts';

export interface RewriteOptions {
  maxAttempts?: number; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2
  minConfidence?: number; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0.7
  preserveGrammar?: boolean; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: true
}

export interface RewriteResponse {
  success: boolean;
  original: {
    question: string;
    choices: string[];
  };
  rewritten: {
    question: string;
    choices: string[];
    correctAnswerIndex: number;
  };
  replacements: Array<{
    original: string;
    replacement: string;
    reason: string;
  }>;
  confidence: number;
  attempts: number;
  error?: string;
}

/**
 * èªå½™é•åã‚’è‡ªå‹•ä¿®æ­£
 */
export async function rewriteQuestion(
  originalQuestion: string,
  originalChoices: string[],
  violations: VocabularyViolation[],
  targetLevel: string,
  env: EikenEnv,
  options: RewriteOptions = {}
): Promise<RewriteResponse> {
  
  const {
    maxAttempts = 2,
    minConfidence = 0.7,
    preserveGrammar = true
  } = options;
  
  const openaiApiKey = env.OPENAI_API_KEY;
  if (!openaiApiKey) {
    return {
      success: false,
      original: { question: originalQuestion, choices: originalChoices },
      rewritten: { question: '', choices: [], correctAnswerIndex: 0 },
      replacements: [],
      confidence: 0,
      attempts: 0,
      error: 'OpenAI API key not configured'
    };
  }
  
  const violatedWords = violations.map(v => v.word);
  
  console.log(`ğŸ”„ Attempting to rewrite question with ${violatedWords.length} violations`);
  console.log(`   Violated words: ${violatedWords.join(', ')}`);
  
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      console.log(`   Attempt ${attempt}/${maxAttempts}...`);
      
      // GPT-4oã§ãƒªãƒ©ã‚¤ãƒˆ
      const rewriteRequest: RewriteRequest = {
        originalQuestion,
        originalChoices,
        violatedWords,
        targetLevel
      };
      
      const prompt = buildRewritePrompt(rewriteRequest);
      
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${openaiApiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4o',
          messages: [
            { role: 'system', content: 'You are an expert at simplifying English text for beginners.' },
            { role: 'user', content: prompt }
          ],
          response_format: { type: 'json_object' },
          temperature: 0.3, // ä½ã‚ã§ä¸€è²«æ€§é‡è¦–
          max_tokens: 800
        })
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`OpenAI API error: ${response.status} - ${errorText}`);
      }
      
      const data = await response.json() as { choices: Array<{ message: { content: string } }> };
      const result = JSON.parse(data.choices[0].message.content) as RewriteResult;
      
      // ä¿¡é ¼åº¦ãƒã‚§ãƒƒã‚¯
      if (result.confidence < minConfidence) {
        console.log(`   âš ï¸ Low confidence: ${result.confidence}, retrying...`);
        continue;
      }
      
      console.log(`   âœ… Rewrite successful (confidence: ${result.confidence})`);
      console.log(`   Replacements: ${result.replacements.map(r => `${r.original}â†’${r.replacement}`).join(', ')}`);
      
      return {
        success: true,
        original: { question: originalQuestion, choices: originalChoices },
        rewritten: {
          question: result.rewrittenQuestion,
          choices: result.rewrittenChoices,
          correctAnswerIndex: result.correctAnswerIndex
        },
        replacements: result.replacements,
        confidence: result.confidence,
        attempts: attempt
      };
      
    } catch (error) {
      console.error(`   âŒ Rewrite attempt ${attempt} failed:`, error);
      
      if (attempt === maxAttempts) {
        return {
          success: false,
          original: { question: originalQuestion, choices: originalChoices },
          rewritten: { question: '', choices: [], correctAnswerIndex: 0 },
          replacements: [],
          confidence: 0,
          attempts: attempt,
          error: error instanceof Error ? error.message : 'Unknown error'
        };
      }
    }
  }
  
  return {
    success: false,
    original: { question: originalQuestion, choices: originalChoices },
    rewritten: { question: '', choices: [], correctAnswerIndex: 0 },
    replacements: [],
    confidence: 0,
    attempts: maxAttempts,
    error: 'Max attempts reached'
  };
}

/**
 * ãƒãƒƒãƒãƒªãƒ©ã‚¤ãƒˆï¼ˆè¤‡æ•°å•é¡Œã‚’ä¸€åº¦ã«å‡¦ç†ï¼‰
 */
export async function rewriteQuestions(
  questions: Array<{
    question: string;
    choices: string[];
    violations: VocabularyViolation[];
  }>,
  targetLevel: string,
  env: EikenEnv,
  options: RewriteOptions = {}
): Promise<RewriteResponse[]> {
  
  const results: RewriteResponse[] = [];
  
  for (const q of questions) {
    const result = await rewriteQuestion(
      q.question,
      q.choices,
      q.violations,
      targetLevel,
      env,
      options
    );
    results.push(result);
    
    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
    await new Promise(resolve => setTimeout(resolve, 500));
  }
  
  return results;
}
```

### Phase 3: Question Generatorçµ±åˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/eiken/services/question-generator.ts` (ä¿®æ­£)

```typescript
// æ—¢å­˜ã®validationå¾Œã«è¿½åŠ 
if (!vocabAnalysis.isValid) {
  console.log(`âŒ Vocabulary violations detected: ${vocabAnalysis.outOfRangeRatio * 100}%`);
  
  // ğŸ†• è‡ªå‹•ãƒªãƒ©ã‚¤ãƒˆè©¦è¡Œ
  console.log(`ğŸ”„ Attempting auto-rewrite...`);
  const rewriteResult = await rewriteQuestion(
    question.questionText,
    question.choices,
    vocabAnalysis.violations || [],
    request.grade,
    env,
    { maxAttempts: 2, minConfidence: 0.7 }
  );
  
  if (rewriteResult.success) {
    console.log(`âœ… Auto-rewrite successful!`);
    
    // ãƒªãƒ©ã‚¤ãƒˆå¾Œã®å•é¡Œã‚’å†æ¤œè¨¼
    const revalidation = await validateVocabularyWithCache(
      `${rewriteResult.rewritten.question} ${rewriteResult.rewritten.choices.join(' ')}`,
      env.DB,
      env.KV,
      { target_level: getCEFRLevel(request.grade) }
    );
    
    if (revalidation.valid) {
      console.log(`âœ… Rewritten question passed validation`);
      // ãƒªãƒ©ã‚¤ãƒˆå¾Œã®å•é¡Œã‚’æ¡ç”¨
      question.questionText = rewriteResult.rewritten.question;
      question.choices = rewriteResult.rewritten.choices;
      question.correctAnswerIndex = rewriteResult.rewritten.correctAnswerIndex;
      // ç¶šè¡Œ
    } else {
      console.log(`âŒ Rewritten question still has violations, rejecting`);
      rejected++;
      continue;
    }
  } else {
    console.log(`âŒ Auto-rewrite failed: ${rewriteResult.error}`);
    rejected++;
    continue;
  }
}
```

### Phase 4: REST API

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/eiken/routes/vocabulary.ts` (æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ )

```typescript
import { rewriteQuestion, type RewriteOptions } from '../services/vocabulary-rewriter';

// POST /api/eiken/vocabulary/rewrite
app.post('/rewrite', async (c) => {
  try {
    const body = await c.req.json<{
      question: string;
      choices: string[];
      violations: VocabularyViolation[];
      target_level: string;
      options?: RewriteOptions;
    }>();
    
    const result = await rewriteQuestion(
      body.question,
      body.choices,
      body.violations,
      body.target_level,
      c.env,
      body.options || {}
    );
    
    return c.json(result);
    
  } catch (error) {
    console.error('Rewrite error:', error);
    return c.json({
      success: false,
      error: 'Failed to rewrite question',
      details: error instanceof Error ? error.message : 'Unknown error'
    }, 500);
  }
});
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### Test 1: Simple Vocabulary Replacement
```typescript
Input:
  Question: "She was delighted to receive the promotion."
  Violations: ["delighted" (B2), "receive" (B1), "promotion" (B1)]

Expected Output:
  Question: "She was happy to get the good news."
  Replacements: [
    { original: "delighted", replacement: "happy", reason: "simpler A1 adjective" },
    { original: "receive", replacement: "get", reason: "basic A1 verb" },
    { original: "promotion", replacement: "good news", reason: "A1 phrase" }
  ]
```

### Test 2: Grammar Preservation
```typescript
Input:
  Question: "The conference will commence next month."
  Violations: ["conference" (B1), "commence" (C1)]

Expected Output:
  Question: "The party will start next month."
  Grammar: Future tense preserved (will + base verb)
```

### Test 3: Multiple Choice Coherence
```typescript
Input:
  Question: "He demonstrated excellent ( ) skills."
  Choices: ["leadership", "management", "communication", "teamwork"]
  Violations: ["demonstrated", "excellent", "leadership", "management", ...]

Expected Output:
  Question: "He showed very good ( ) skills."
  Choices: ["leading", "planning", "talking", "teamwork"]
  Note: All choices must remain valid options
```

## ğŸ“Š è©•ä¾¡æŒ‡æ¨™

### Success Metrics
1. **Rewrite Success Rate**: >90%
2. **Post-Rewrite Validation Pass Rate**: >95%
3. **Overall Generation Success Rate**: >98%
4. **Average Confidence Score**: >0.8

### Cost Metrics
1. **API Calls per Question**: <1.1 (including rewrites)
2. **Average Tokens per Rewrite**: ~500
3. **Total Generation Time**: <5s per question

## ğŸ”§ å®Ÿè£…é †åº

### Day 3: ã‚³ã‚¢æ©Ÿèƒ½å®Ÿè£…
1. âœ… `rewrite-prompts.ts` - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ
2. âœ… `vocabulary-rewriter.ts` - ãƒªãƒ©ã‚¤ãƒˆãƒ­ã‚¸ãƒƒã‚¯
3. âœ… å‹å®šç¾©è¿½åŠ  (`RewriteRequest`, `RewriteResult`, etc.)

### Day 4: çµ±åˆã¨ãƒ†ã‚¹ãƒˆ
4. âœ… `question-generator.ts` - çµ±åˆ
5. âœ… REST APIè¿½åŠ  (`/api/eiken/vocabulary/rewrite`)
6. âœ… ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ (`test-auto-rewrite.ts`)
7. âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ

## ğŸ¯ æˆåŠŸåŸºæº–

- [  ] ãƒªãƒ©ã‚¤ãƒˆæˆåŠŸç‡ >90%
- [  ] å†æ¤œè¨¼åˆæ ¼ç‡ >95%
- [  ] å…¨ä½“ç”ŸæˆæˆåŠŸç‡ >98%
- [  ] APIå‘¼ã³å‡ºã— <1.1å›/å•é¡Œ
- [  ] å¹³å‡ä¿¡é ¼åº¦ >0.8
- [  ] ãƒ“ãƒ«ãƒ‰æˆåŠŸ
- [  ] å…¨ãƒ†ã‚¹ãƒˆãƒ‘ã‚¹

---

**å®Ÿè£…é–‹å§‹**: 2025-11-12  
**ç›®æ¨™å®Œäº†**: Week 2 Day 3-4  
**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: Week 2-3 Cron Workerå®Ÿè£…
