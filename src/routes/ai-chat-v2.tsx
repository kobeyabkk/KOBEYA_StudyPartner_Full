import { Hono } from 'hono'

type Bindings = {
  OPENAI_API_KEY: string
  DB: D1Database
  WEBHOOK_SECRET: string
  VERSION: string
}

const router = new Hono<{ Bindings: Bindings }>()

// ==========================================
router.get('/:sessionId', (c) => {
  const sessionId = c.req.param('sessionId')
  console.log('ğŸ¤– AI Chat V2: Simple version requested for session:', sessionId)
  
  return c.html(`
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå­¦ç¿’ã‚µãƒãƒ¼ãƒˆ - KOBEYA</title>
    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- Cropper.js for image cropping -->
    <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.css">
    <script src="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #7c3aed, #8b5cf6);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .chat-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: #f8fafc;
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 1rem;
            max-width: 80%;
            line-height: 1.6;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            background: #e0e7ff;
            margin-left: auto;
            text-align: right;
        }
        
        .message.ai {
            background: white;
            border: 1px solid #e5e7eb;
        }
        
        .message.loading {
            background: white;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .loading-dots {
            display: flex;
            gap: 4px;
        }
        
        .loading-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #7c3aed;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }
        
        .chat-input-area {
            padding: 1rem;
            background: white;
            border-top: 1px solid #e5e7eb;
        }
        
        .input-group {
            display: flex;
            gap: 0.5rem;
        }
        
        #messageInput {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }
        
        #messageInput:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        
        #sendButton {
            padding: 0.75rem 1.5rem;
            background: #7c3aed;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #sendButton:hover {
            background: #6d28d9;
            transform: translateY(-1px);
        }
        
        #sendButton:active {
            transform: translateY(0);
        }
        
        #sendButton:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        /* Camera & Image Styles */
        .camera-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .camera-buttons button {
            flex: 1;
            padding: 0.75rem;
            background: #374151;
            font-size: 0.9rem;
        }
        
        .camera-buttons button:hover:not(:disabled) {
            background: #1f2937;
        }
        
        .image-preview-area {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            overflow: hidden;
            display: none;
        }
        
        .image-preview-area.active {
            display: block;
        }
        
        /* Crop area - visible overlay when active */
        .crop-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        
        .crop-area.active {
            display: flex;
        }
        
        .preview-header {
            background: #f3f4f6;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .crop-header {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .preview-content {
            padding: 1rem;
        }
        
        .crop-content {
            max-width: 90vw;
            max-height: 70vh;
            overflow: auto;
            text-align: center;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 0.5rem;
        }
        
        .crop-image {
            max-width: 100%;
            max-height: 60vh;
            display: block;
            background: white;
        }
        
        .preview-actions {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 0.5rem;
        }
        
        .crop-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }
        
        .preview-actions button {
            flex: 1;
            padding: 0.75rem;
            font-size: 0.9rem;
        }
        
        .crop-actions button {
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-secondary {
            background: #ef4444 !important;
            color: white !important;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #dc2626 !important;
        }
        
        .btn-success {
            background: #10b981 !important;
            color: white !important;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #059669 !important;
        }
        
        input[type="file"] {
            display: none;
        }
        
        /* Cropper.js handle sizes */
        .cropper-point {
            width: 12px !important;
            height: 12px !important;
            opacity: 0.95 !important;
        }
        
        .cropper-point:hover {
            opacity: 1 !important;
            transform: scale(1.2);
        }
        
        .cropper-point.point-nw,
        .cropper-point.point-ne,
        .cropper-point.point-sw,
        .cropper-point.point-se {
            background-color: #10b981 !important;
            border-radius: 50%;
        }
        
        .cropper-point.point-n,
        .cropper-point.point-s,
        .cropper-point.point-e,
        .cropper-point.point-w {
            background-color: #059669 !important;
            border-radius: 2px;
        }
        
        .cropper-crop-box {
            border: 2px solid #10b981 !important;
        }
        
        .cropper-view-box {
            outline: 2px solid #10b981 !important;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>ğŸ¤– AIå­¦ç¿’ã‚µãƒãƒ¼ãƒˆ</h1>
            <p style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.9;">ä½•ã§ã‚‚ãŠèããã ã•ã„ï¼</p>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                ã“ã‚“ã«ã¡ã¯ï¼å­¦ç¿’ã§ã‚ã‹ã‚‰ãªã„ã“ã¨ãŒã‚ã‚Œã°ã€ä½•ã§ã‚‚è³ªå•ã—ã¦ãã ã•ã„ã€‚ä¸å¯§ã«èª¬æ˜ã„ãŸã—ã¾ã™ï¼
            </div>
        </div>
        
        <!-- Image Preview Area -->
        <div class="image-preview-area" id="imagePreviewArea">
            <div class="preview-header">ğŸ“¸ é¸æŠã•ã‚ŒãŸç”»åƒ</div>
            <div class="preview-content">
                <img id="previewImage" class="preview-image" alt="Preview">
            </div>
            <div class="preview-actions">
                <button id="btnClearImage" class="btn-secondary">
                    <i class="fas fa-times"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button id="btnStartCrop" class="btn-success">
                    <i class="fas fa-crop"></i> ç¯„å›²ã‚’èª¿æ•´
                </button>
            </div>
            <div style="padding: 0.5rem 1rem; background: #f0fdf4; border-top: 1px solid #e5e7eb;">
                <p style="margin: 0; font-size: 0.85rem; color: #059669;">
                    ğŸ’¡ ä¸‹ã®å…¥åŠ›æ¬„ã«è³ªå•ã‚’å…¥åŠ›ã—ã¦ã€é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„
                </p>
            </div>
        </div>
        
        <!-- Crop Area -->
        <div class="crop-area" id="cropArea">
            <div class="crop-header">âœ‚ï¸ ç¯„å›²ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            <div class="crop-content">
                <img id="cropImage" class="crop-image" alt="Crop">
            </div>
            <div class="crop-actions">
                <button id="btnCancelCrop" class="btn-secondary">
                    <i class="fas fa-times"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button id="btnConfirmCrop" class="btn-success">
                    <i class="fas fa-check"></i> ç¢ºå®š
                </button>
            </div>
        </div>
        
        <div class="chat-input-area">
            <!-- Camera Buttons -->
            <div class="camera-buttons">
                <button id="cameraButton">
                    <i class="fas fa-camera"></i> ã‚«ãƒ¡ãƒ©
                </button>
                <button id="fileButton">
                    <i class="fas fa-folder-open"></i> ãƒ•ã‚¡ã‚¤ãƒ«
                </button>
            </div>
            <input type="file" id="cameraInput" accept="image/*" capture="environment">
            <input type="file" id="fileInput" accept="image/*">
            
            <div class="input-group">
                <textarea 
                    id="messageInput" 
                    placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                    rows="1"
                ></textarea>
                <button id="sendButton">é€ä¿¡</button>
            </div>
        </div>
    </div>
    
    <script>
        console.log('ğŸš€ AI Chat V2 script starting...');
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ³¨å…¥ï¼‰
        const SESSION_ID = ${JSON.stringify(sessionId)};
        console.log('ğŸ“ Session ID:', SESSION_ID);
        
        // DOMè¦ç´ 
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        
        console.log('ğŸ“ Basic elements:', {
            chatMessages: !!chatMessages,
            messageInput: !!messageInput,
            sendButton: !!sendButton
        });
        
        // Camera elements
        const cameraButton = document.getElementById('cameraButton');
        const fileButton = document.getElementById('fileButton');
        const cameraInput = document.getElementById('cameraInput');
        const fileInput = document.getElementById('fileInput');
        const imagePreviewArea = document.getElementById('imagePreviewArea');
        const previewImage = document.getElementById('previewImage');
        const btnClearImage = document.getElementById('btnClearImage');
        const btnStartCrop = document.getElementById('btnStartCrop');
        const btnSendDirect = document.getElementById('btnSendDirect');
        const cropArea = document.getElementById('cropArea');
        
        console.log('ğŸ“· Camera elements:', {
            cameraButton: !!cameraButton,
            fileButton: !!fileButton,
            cameraInput: !!cameraInput,
            fileInput: !!fileInput
        });
        const cropImage = document.getElementById('cropImage');
        const btnCancelCrop = document.getElementById('btnCancelCrop');
        const btnConfirmCrop = document.getElementById('btnConfirmCrop');
        
        let cropper = null;
        let currentImageData = null;
        
        // KaTeX delimiters (simplified - only $ and $$ to avoid escaping issues)
        const mathDelimiters = [
            {left: '$$', right: '$$', display: true},
            {left: '\\[', right: '\\]', display: true},
            {left: '$', right: '$', display: false},
            {left: '\\(', right: '\\)', display: false}
        ];
        
        // åˆæœŸåŒ–ãƒ­ã‚°
        console.log('âœ… AI Chat V2 initialized');
        console.log('ğŸ“ Session ID:', SESSION_ID);
        console.log('ğŸ“· Camera button element:', cameraButton);
        console.log('ğŸ“ File button element:', fileButton);
        console.log('ğŸ“¸ Camera input element:', cameraInput);
        console.log('ğŸ—‚ï¸ File input element:', fileInput);
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ é–¢æ•°ï¼ˆæ”¹è¡Œã¨KaTeXå¯¾å¿œï¼‰
        function addMessage(text, type = 'user') {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + type;
            
            // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã€æ•°å­¦è¨˜å·ã‚’è‡ªå‹•å¤‰æ›
            let processedText = text;
            if (type === 'ai') {
                // ã€Œè§’ ABCã€â†’ã€Œâˆ ABCã€
                processedText = processedText.replace(/è§’\s*([A-Z]{2,4})/g, 'âˆ $1');
                // ã€Œä¸‰è§’å½¢ ABCã€â†’ã€Œâ–³ABCã€
                processedText = processedText.replace(/ä¸‰è§’å½¢\s*([A-Z]{3,4})/g, 'â–³$1');
                // ã€Œç·šåˆ† ABã€â†’ã€ŒABã€ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
                processedText = processedText.replace(/ç·šåˆ†\s*([A-Z]{2})/g, '$1');
                // ã€Œè¾º ABã€â†’ã€ŒABã€ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
                processedText = processedText.replace(/è¾º\s*([A-Z]{2})/g, '$1');
            }
            
            // æ”¹è¡Œã‚’<br>ã‚¿ã‚°ã«å¤‰æ›ï¼ˆViteãƒ“ãƒ«ãƒ‰å¯¾å¿œï¼‰
            const newlineChar = String.fromCharCode(10);
            const regex = new RegExp(newlineChar, 'g');
            const formattedText = processedText.replace(regex, '<br>');
            messageDiv.innerHTML = formattedText;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã€KaTeXã§æ•°å¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            if (type === 'ai') {
                setTimeout(() => {
                    if (typeof renderMathInElement !== 'undefined') {
                        try {
                            renderMathInElement(messageDiv, {
                                delimiters: mathDelimiters,
                                throwOnError: false
                            });
                            console.log('âœ… KaTeX rendering applied');
                        } catch (error) {
                            console.error('âŒ KaTeX rendering error:', error);
                        }
                    } else {
                        console.warn('âš ï¸ renderMathInElement not loaded yet');
                    }
                }, 100);
            }
            
            return messageDiv;
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message loading';
            loadingDiv.innerHTML = '<span>è€ƒãˆã¦ã„ã¾ã™</span><div class="loading-dots"><span></span><span></span><span></span></div>';
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return loadingDiv;
        }
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = 'âŒ ' + message;
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        async function sendMessage() {
            const message = messageInput.value.trim();
            
            // If image preview is active, send image message instead
            if (imagePreviewArea.classList.contains('active') && currentImageData) {
                console.log('ğŸ“¤ Sending image message with question');
                sendImageMessage(currentImageData);
                return;
            }
            
            if (!message) {
                return;
            }
            
            console.log('ğŸ“¤ Sending text message:', message);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            addMessage(message, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // é€ä¿¡ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
            sendButton.disabled = true;
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const loadingDiv = showLoading();
            
            try {
                // APIå‘¼ã³å‡ºã—
                const response = await fetch('/api/ai-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: SESSION_ID,
                        question: message
                    })
                });
                
                const data = await response.json();
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å‰Šé™¤
                loadingDiv.remove();
                
                if (data.ok && data.answer) {
                    console.log('âœ… Response received');
                    addMessage(data.answer, 'ai');
                } else {
                    console.error('âŒ API error:', data.message);
                    showError(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('âŒ Network error:', error);
                loadingDiv.remove();
                showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            } finally {
                sendButton.disabled = false;
                messageInput.focus();
            }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        console.log('ğŸ”— Setting up event listeners...');
        
        if (sendButton) {
            sendButton.addEventListener('click', () => {
                console.log('ğŸ–±ï¸ Send button clicked');
                sendMessage();
            });
            console.log('âœ… Send button listener attached');
        } else {
            console.error('âŒ Send button not found!');
        }
        
        if (messageInput) {
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    console.log('âŒ¨ï¸ Enter key pressed');
                    sendMessage();
                }
            });
            console.log('âœ… Message input listener attached');
        } else {
            console.error('âŒ Message input not found!');
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢è‡ªå‹•ãƒªã‚µã‚¤ã‚º
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // åˆæœŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        messageInput.focus();
        
        console.log('âœ… Event listeners attached');
        
        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ•°å¼ã‚‚ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        setTimeout(() => {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: mathDelimiters,
                    throwOnError: false
                });
            }
        }, 500);
        
        // ========== Camera & Image Functions ==========
        
        console.log('ğŸ”§ Setting up camera event listeners...');
        
        // Camera button click - Trigger camera input
        if (cameraButton) {
            console.log('âœ… Camera button found, adding event listener');
            cameraButton.addEventListener('click', () => {
                console.log('ğŸ“· Camera button clicked - triggering camera input');
                if (cameraInput) {
                    console.log('ğŸ“¸ Triggering camera input element');
                    cameraInput.click();
                } else {
                    console.error('âŒ Camera input not found');
                }
            });
        } else {
            console.error('âŒ Camera button not found in DOM');
        }
        
        // File button click
        if (fileButton) {
            console.log('âœ… File button found, adding event listener');
            fileButton.addEventListener('click', () => {
                console.log('ğŸ“ File button clicked');
                if (fileInput) {
                    console.log('ğŸ—‚ï¸ Triggering file input');
                    fileInput.click();
                } else {
                    console.error('âŒ File input not found');
                }
            });
        } else {
            console.error('âŒ File button not found in DOM');
        }
        
        // Handle image selection
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('ğŸ“¸ Image selected:', file.name);
            
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImageData = e.target.result;
                previewImage.src = currentImageData;
                imagePreviewArea.classList.add('active');
                cropArea.classList.remove('active');
            };
            reader.readAsDataURL(file);
        }
        
        if (cameraInput) cameraInput.addEventListener('change', handleImageSelect);
        if (fileInput) fileInput.addEventListener('change', handleImageSelect);
        
        // Clear image
        if (btnClearImage) {
            btnClearImage.addEventListener('click', () => {
                console.log('âŒ Clear image');
                imagePreviewArea.classList.remove('active');
                cropArea.classList.remove('active');
                currentImageData = null;
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                cameraInput.value = '';
                fileInput.value = '';
            });
        }
        
        // Start crop
        if (btnStartCrop) {
            btnStartCrop.addEventListener('click', () => {
                console.log('âœ‚ï¸ Start crop');
                cropImage.src = currentImageData;
                imagePreviewArea.classList.remove('active');
                cropArea.classList.add('active');
                
                setTimeout(() => {
                    if (cropper) cropper.destroy();
                    
                    cropper = new Cropper(cropImage, {
                        aspectRatio: NaN, // Free aspect ratio
                        viewMode: 1,
                        dragMode: 'move',
                        autoCropArea: 0.95,
                        responsive: true,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                        ready: function() {
                            console.log('âœ‚ï¸ Cropper initialized');
                        }
                    });
                }, 100);
            });
        }
        
        // Cancel crop
        if (btnCancelCrop) {
            btnCancelCrop.addEventListener('click', () => {
                console.log('â¬…ï¸ Cancel crop');
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                cropArea.classList.remove('active');
                imagePreviewArea.classList.add('active');
            });
        }
        
        // Confirm crop
        if (btnConfirmCrop) {
            btnConfirmCrop.addEventListener('click', () => {
                console.log('âœ… Confirm crop');
                
                if (cropper) {
                    const canvas = cropper.getCroppedCanvas({
                        maxWidth: 2000,
                        maxHeight: 2000,
                        fillColor: '#fff',
                        imageSmoothingEnabled: true,
                        imageSmoothingQuality: 'high'
                    });
                    
                    currentImageData = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // Update preview with cropped image
                    previewImage.src = currentImageData;
                    
                    cropper.destroy();
                    cropper = null;
                }
                
                // Return to preview area for question input
                cropArea.classList.remove('active');
                imagePreviewArea.classList.add('active');
                
                // Focus on message input
                messageInput.focus();
            });
        }
        
        // btnSendDirect removed - use main send button with image preview active
        
        // Send image message
        async function sendImageMessage(imageData) {
            if (!imageData) return;
            
            const message = messageInput.value.trim() || 'ç”»åƒã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„';
            
            console.log('ğŸ“¤ Sending image message');
            
            // Hide image areas
            imagePreviewArea.classList.remove('active');
            cropArea.classList.remove('active');
            
            // Add user message
            addMessage('ğŸ“· ' + message, 'user');
            messageInput.value = '';
            
            sendButton.disabled = true;
            const loadingDiv = showLoading();
            
            try {
                // Convert base64 to blob
                const response = await fetch(imageData);
                const blob = await response.blob();
                
                // Create FormData
                const formData = new FormData();
                formData.append('image', blob, 'image.jpg');
                formData.append('sessionId', SESSION_ID);
                formData.append('message', message);
                
                // Send to API
                const apiResponse = await fetch('/api/ai-chat-image', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await apiResponse.json();
                
                loadingDiv.remove();
                
                if (data.ok) {
                    console.log('âœ… Image response received');
                    addMessage(data.answer, 'ai');
                } else {
                    console.error('âŒ API error:', data.message);
                    showError(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('âŒ Network error:', error);
                loadingDiv.remove();
                showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                sendButton.disabled = false;
                messageInput.focus();
                currentImageData = null;
                cameraInput.value = '';
                fileInput.value = '';
            }
        }
        
        console.log('âœ… Camera functions initialized');
    </script>
</body>
</html>
  `)
})

export default router
