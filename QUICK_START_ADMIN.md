# 管理画面クイックスタートガイド

## 🚀 5分でセットアップ

### ステップ1: マイグレーション実行（3分）

#### Cloudflare Dashboard にアクセス
1. https://dash.cloudflare.com/ → Workers & Pages
2. プロジェクト選択 → Settings → Bindings
3. **kobeya-logs-db** をクリック → **Console** タブ

#### SQL実行（コピー&ペーストのみ）

**🔹 ファイル1を実行**: `migrations/0013_FINAL_create_users_table.sql`
```
全文をコピー → Console に貼り付け → Execute
```

**🔹 ファイル2を実行**: `migrations/0014_FINAL_migrate_existing_users.sql`
```
全文をコピー → Console に貼り付け → Execute
```

**🔹 検証**: 以下を実行して確認
```sql
SELECT COUNT(*) as total_users FROM users;
```
→ 1以上の数値が表示されればOK ✅

### ステップ2: デプロイ（1分）

```bash
npm run deploy
```

または

```bash
wrangler deploy
```

### ステップ3: ログイン（1分）

1. **https://your-app.pages.dev/admin/login** にアクセス
2. パスワード入力: `admin123`
3. ログインボタンをクリック

→ 生徒一覧ページが表示されれば成功！🎉

## 📱 管理画面の使い方

### 生徒一覧ページ (`/admin/users`)

#### できること
- ✅ 全生徒の一覧表示
- ✅ 検索（学生ID、氏名で検索）
- ✅ 統計表示（総生徒数、有効生徒、セッション数）
- ✅ 新規生徒追加
- ✅ 生徒情報編集
- ✅ 生徒削除（学習履歴がない場合のみ）
- ✅ 生徒詳細ページへ移動

#### 新規生徒追加
1. **新規追加** ボタンをクリック
2. フォーム入力：
   - APP_KEY: `180418`（デフォルト）
   - 学生ID: 任意の文字列（必須）
   - 氏名: 生徒の名前（必須）
   - 学年: 例「中学3年」（任意）
   - メールアドレス: 連絡先（任意）
   - メモ: 特記事項（任意）
3. **保存** ボタンをクリック

#### 生徒情報編集
1. 該当する生徒の **編集** ボタンをクリック
2. 情報を修正
3. **保存** ボタンをクリック

#### 生徒削除
1. 該当する生徒の **削除** ボタンをクリック
2. 確認ダイアログで確認
3. **OK** をクリック

**注意**: 学習履歴がある生徒は削除できません（データ保護）

### 生徒詳細ページ (`/admin/users/:id`)

#### 表示される情報
- 📋 **基本情報**
  - APP_KEY
  - 学生ID
  - 氏名
  - 学年
  - メールアドレス
  - 登録日
  - 最終ログイン日
  - メモ
  - ステータス（有効/無効）

- 📊 **学習統計**
  - 学習セッション数
  - エッセイ提出数
  - フラッシュカード数
  - 国際交流数

#### できること
- ✅ 生徒情報の表示
- ✅ インライン編集（編集ボタンからモーダル表示）
- ✅ 学習統計の確認
- ✅ 生徒一覧へ戻る

## 🔐 セキュリティ設定

### 管理者パスワード変更（推奨）

現在のパスワード `admin123` は開発用です。本番環境では変更してください。

#### パスワード変更方法（Cloudflare D1 Console）

```sql
-- 新しいパスワードのハッシュを生成（bcrypt）
-- ここでは例として "new_secure_password" を使用

UPDATE admin_settings 
SET password_hash = 'your_new_bcrypt_hash', 
    updated_at = CURRENT_TIMESTAMP
WHERE id = 1;
```

**注意**: 現在の実装は簡易認証です。本格的な認証システムは今後実装予定。

### ログアウト

すべてのページ右上に **ログアウト** ボタンがあります。
- クリックするとログイントークンが削除され、ログインページへリダイレクトされます

## 📋 よくある質問

### Q1: ログインできません
**A**: 以下を確認してください：
1. パスワードは `admin123` ですか？
2. マイグレーションは実行済みですか？
3. ブラウザの開発者ツールでエラーを確認してください

### Q2: 生徒が表示されません
**A**: 以下を確認してください：
1. マイグレーション0014が正常に実行されましたか？
2. Cloudflare D1 Console で以下を実行：
```sql
SELECT COUNT(*) FROM users;
```
3. 0の場合は、新規追加ボタンから手動で追加してください

### Q3: 学習統計が0です
**A**: 以下の可能性があります：
1. 実際に学習データがない（新規生徒）
2. user_id のリンクが正しくない
3. Cloudflare D1 Console で検証：
```sql
SELECT * FROM essay_sessions WHERE user_id IS NULL LIMIT 5;
SELECT * FROM flashcards WHERE user_id IS NULL LIMIT 5;
```

### Q4: 生徒を削除できません
**A**: その生徒に学習履歴があります。
- 学習データを保護するため、履歴がある生徒は削除できません
- 代わりに「無効」にすることができます（編集ボタン → is_active のチェックを外す）

### Q5: 検索が動きません
**A**: 以下を確認：
1. ブラウザのJavaScriptが有効になっていますか？
2. ブラウザコンソールにエラーが表示されていますか？
3. ページをリロードしてみてください

## 🛠️ トラブルシューティング

### エラー: "Failed to fetch"
**原因**: APIエンドポイントにアクセスできない
**対応**: 
1. デプロイが完了していることを確認
2. ネットワーク接続を確認
3. Cloudflare のステータスを確認

### エラー: "Unauthorized"
**原因**: ログイントークンが無効または期限切れ
**対応**:
1. ログアウトして再度ログイン
2. ブラウザのキャッシュをクリア
3. localStorageをクリア（開発者ツール → Application → Local Storage）

### エラー: "Database error"
**原因**: データベース接続またはクエリエラー
**対応**:
1. Cloudflare D1 のステータスを確認
2. マイグレーションが正常に実行されたか確認
3. ブラウザコンソールで詳細なエラーメッセージを確認

## 📚 関連ドキュメント

- **MIGRATION_EXECUTION_GUIDE.md** - 詳細なマイグレーション手順
- **MIGRATION_ERROR_RESOLUTION.md** - エラー発生時の対応
- **STEP2_COMPLETION_REPORT.md** - 実装の詳細
- **Pull Request #55** - コードレビュー用

## 🎯 次のステップ

管理画面が動いたら：

1. **生徒を追加**
   - 既存の学生をシステムに登録
   - APP_KEY は `180418` を使用

2. **学習履歴を確認**
   - 各生徒の詳細ページで統計を確認
   - データが正しくリンクされているか確認

3. **Step 3 へ進む**
   - ログイン機能をusersテーブルに統合
   - セッション管理の改善

---

**作成日**: 2024-11-18  
**バージョン**: 1.0  
**対象**: 管理者（先生・教室運営者）

何か問題があれば、上記のトラブルシューティングを参照するか、詳細なエラーログを添えて報告してください！
