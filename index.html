<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KOBEYA Study Partner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ã‚«ãƒ¡ãƒ©ã‚³ãƒ³ãƒ†ãƒŠ - ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        .camera-container {
            position: relative;
            width: 100%;
            max-height: 60vh; /* ç”»é¢ã®60%ã‚’æœ€å¤§é«˜ã•ã« */
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #video, #canvas {
            width: 100%;
            height: auto;
            max-height: 60vh; /* ãƒ“ãƒ‡ã‚ªã‚‚æœ€å¤§é«˜ã•åˆ¶é™ */
            display: block;
            object-fit: contain; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒ */
        }

        #canvas {
            display: none;
        }

        .camera-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .camera-overlay button {
            padding: 12px 20px;
            font-size: 14px;
        }

        .captured-image {
            width: 100%;
            max-height: 60vh;
            border-radius: 15px;
            object-fit: contain;
            background: #000;
        }

        .image-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            min-height: 100px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .camera-controls select {
            flex: 1;
            min-width: 150px;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            background: white;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .content {
                padding: 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            button {
                padding: 12px 20px;
                font-size: 14px;
            }

            .camera-overlay {
                padding: 15px;
                flex-wrap: wrap;
            }

            .camera-overlay button {
                flex: 1;
                min-width: 100px;
            }

            .camera-container {
                max-height: 50vh; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã•ã‚‰ã«å°ã•ã */
            }

            #video {
                max-height: 50vh;
            }
        }

        /* AIãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 22px;
            margin: 0;
        }

        .close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: all 0.3s;
        }

        .close:hover {
            transform: scale(1.1);
        }

        .modal-body {
            padding: 30px;
        }

        .ai-question-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s;
        }

        .ai-question-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– KOBEYA Study Partner</h1>
            <p>éŠã³ãªãŒã‚‰å­¦ã¶ï¼å°å­¦ç”Ÿã‹ã‚‰ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°æ•™å®¤</p>
        </div>

        <div class="content">
            <!-- èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <div class="section-title">ğŸ” èªè¨¼æƒ…å ±</div>
                <div class="input-group">
                    <label for="appKey">APP_KEY</label>
                    <input type="text" id="appKey" placeholder="APP_KEYã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                </div>
                <div class="input-group">
                    <label for="studentId">ID</label>
                    <input type="text" id="studentId" placeholder="å­¦ç”ŸIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                </div>
            </div>

            <!-- ã‚«ãƒ¡ãƒ©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <div class="section-title">ğŸ“¸ ã‚«ãƒ¡ãƒ©</div>
                
                <!-- ã‚«ãƒ¡ãƒ©é¸æŠ -->
                <div class="camera-controls">
                    <select id="cameraSelect">
                        <option value="">ã‚«ãƒ¡ãƒ©ã‚’é¸æŠ...</option>
                    </select>
                    <button class="btn-secondary" onclick="switchCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
                </div>

                <!-- ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                <div class="camera-container" id="cameraContainer" style="display: none;">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                    <div class="camera-overlay">
                        <button class="btn-danger" onclick="stopCamera()">åœæ­¢</button>
                        <button class="btn-success" onclick="capturePhoto()">ğŸ“¸ æ’®å½±</button>
                    </div>
                </div>

                <!-- æ’®å½±ã—ãŸç”»åƒ -->
                <div id="capturedImageContainer" class="hidden">
                    <img id="capturedImage" class="captured-image" alt="æ’®å½±ã—ãŸç”»åƒ">
                    <div class="image-actions">
                        <button class="btn-primary" onclick="cropImage()">âœ‚ï¸ ã‚¯ãƒ­ãƒƒãƒ—</button>
                        <button class="btn-secondary" onclick="retakePhoto()">ğŸ”„ æ’®ã‚Šç›´ã—</button>
                    </div>
                </div>

                <!-- ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ -->
                <div class="button-group">
                    <button class="btn-primary" onclick="startCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±</button>
                </div>
            </div>

            <!-- OCRçµæœ -->
            <div class="section">
                <div class="section-title">ğŸ“„ OCRçµæœ</div>
                <div class="result-box" id="ocrResult">ã“ã“ã«OCRçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="section">
                <div class="button-group">
                    <button class="btn-primary" onclick="openAIQuestionModal()">ğŸ’¬ AIã«è³ªå•</button>
                    <button class="btn-secondary" onclick="performOCR()">ğŸ” OCRå®Ÿè¡Œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AIã«è³ªå•ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="aiQuestionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ’¬ AIã«è³ªå•</h2>
                <span class="close" onclick="closeAIQuestionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="aiQuestion">è³ªå•å†…å®¹</label>
                    <textarea id="aiQuestion" class="ai-question-textarea" placeholder="AIã«èããŸã„ã“ã¨ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                </div>

                <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚«ãƒ¡ãƒ©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="section">
                    <div class="section-title">ğŸ“¸ å‚è€ƒç”»åƒã‚’æ’®å½±ï¼ˆä»»æ„ï¼‰</div>
                    
                    <div class="camera-controls">
                        <select id="modalCameraSelect">
                            <option value="">ã‚«ãƒ¡ãƒ©ã‚’é¸æŠ...</option>
                        </select>
                        <button class="btn-secondary" onclick="switchModalCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
                    </div>

                    <div class="camera-container" id="modalCameraContainer" style="display: none;">
                        <video id="modalVideo" autoplay playsinline></video>
                        <canvas id="modalCanvas"></canvas>
                        <div class="camera-overlay">
                            <button class="btn-danger" onclick="stopModalCamera()">åœæ­¢</button>
                            <button class="btn-success" onclick="captureModalPhoto()">ğŸ“¸ æ’®å½±</button>
                        </div>
                    </div>

                    <div id="modalCapturedImageContainer" class="hidden">
                        <img id="modalCapturedImage" class="captured-image" alt="æ’®å½±ã—ãŸç”»åƒ">
                        <div class="image-actions">
                            <button class="btn-primary" onclick="cropModalImage()">âœ‚ï¸ ã‚¯ãƒ­ãƒƒãƒ—</button>
                            <button class="btn-secondary" onclick="retakeModalPhoto()">ğŸ”„ æ’®ã‚Šç›´ã—</button>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn-primary" onclick="startModalCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±</button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ¤– AIå›ç­”</div>
                    <div class="result-box" id="aiResult">ã“ã“ã«AIã®å›ç­”ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="submitAIQuestion()">âœ… è³ªå•ã‚’é€ä¿¡</button>
                    <button class="btn-secondary" onclick="closeAIQuestionModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let stream = null;
        let modalStream = null;
        let cameras = [];
        let currentCameraIndex = 0;
        let capturedImageData = null;
        let modalCapturedImageData = null;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚«ãƒ¡ãƒ©ã‚’åˆ—æŒ™
        window.addEventListener('load', async () => {
            await enumerateCameras();
        });

        // ã‚«ãƒ¡ãƒ©ã‚’åˆ—æŒ™
        async function enumerateCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                cameras = devices.filter(device => device.kind === 'videoinput');
                
                const cameraSelect = document.getElementById('cameraSelect');
                const modalCameraSelect = document.getElementById('modalCameraSelect');
                
                cameraSelect.innerHTML = '<option value="">ã‚«ãƒ¡ãƒ©ã‚’é¸æŠ...</option>';
                modalCameraSelect.innerHTML = '<option value="">ã‚«ãƒ¡ãƒ©ã‚’é¸æŠ...</option>';
                
                cameras.forEach((camera, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = camera.label || `ã‚«ãƒ¡ãƒ© ${index + 1}`;
                    cameraSelect.appendChild(option.cloneNode(true));
                    modalCameraSelect.appendChild(option);
                });
            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©ã®åˆ—æŒ™ã«å¤±æ•—:', error);
            }
        }

        // ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
        async function startCamera() {
            try {
                const cameraSelect = document.getElementById('cameraSelect');
                const selectedIndex = cameraSelect.value;
                
                let constraints;
                if (selectedIndex !== '') {
                    const deviceId = cameras[selectedIndex].deviceId;
                    constraints = {
                        video: {
                            deviceId: { exact: deviceId },
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    };
                    currentCameraIndex = parseInt(selectedIndex);
                } else {
                    constraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    };
                }

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                document.getElementById('cameraContainer').style.display = 'block';
                document.getElementById('capturedImageContainer').classList.add('hidden');
            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—:', error);
                alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById('cameraContainer').style.display = 'none';
        }

        // ã‚«ãƒ¡ãƒ©ã‚’åˆ‡ã‚Šæ›¿ãˆ
        async function switchCamera() {
            if (cameras.length <= 1) {
                alert('åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ã‚«ãƒ¡ãƒ©ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            stopCamera();
            currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
            document.getElementById('cameraSelect').value = currentCameraIndex;
            await startCamera();
        }

        // å†™çœŸã‚’æ’®å½±
        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            capturedImageData = canvas.toDataURL('image/jpeg', 0.95);
            document.getElementById('capturedImage').src = capturedImageData;
            document.getElementById('capturedImageContainer').classList.remove('hidden');
            
            stopCamera();
        }

        // æ’®ã‚Šç›´ã—
        function retakePhoto() {
            capturedImageData = null;
            document.getElementById('capturedImageContainer').classList.add('hidden');
            startCamera();
        }

        // ã‚¯ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function cropImage() {
            if (!capturedImageData) {
                alert('ç”»åƒãŒæ’®å½±ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            alert('ã‚¯ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ã€‚ç¾åœ¨ã¯æ’®å½±ã—ãŸç”»åƒã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¾ã™ã€‚');
        }

        // === ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ ===

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
        async function startModalCamera() {
            try {
                const modalCameraSelect = document.getElementById('modalCameraSelect');
                const selectedIndex = modalCameraSelect.value;
                
                let constraints;
                if (selectedIndex !== '') {
                    const deviceId = cameras[selectedIndex].deviceId;
                    constraints = {
                        video: {
                            deviceId: { exact: deviceId },
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    };
                } else {
                    constraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    };
                }

                modalStream = await navigator.mediaDevices.getUserMedia(constraints);
                const modalVideo = document.getElementById('modalVideo');
                modalVideo.srcObject = modalStream;
                
                document.getElementById('modalCameraContainer').style.display = 'block';
                document.getElementById('modalCapturedImageContainer').classList.add('hidden');
            } catch (error) {
                console.error('ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—:', error);
                alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢
        function stopModalCamera() {
            if (modalStream) {
                modalStream.getTracks().forEach(track => track.stop());
                modalStream = null;
            }
            document.getElementById('modalCameraContainer').style.display = 'none';
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚«ãƒ¡ãƒ©ã‚’åˆ‡ã‚Šæ›¿ãˆ
        async function switchModalCamera() {
            if (cameras.length <= 1) {
                alert('åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ã‚«ãƒ¡ãƒ©ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            stopModalCamera();
            const modalCameraSelect = document.getElementById('modalCameraSelect');
            let currentIndex = parseInt(modalCameraSelect.value) || 0;
            currentIndex = (currentIndex + 1) % cameras.length;
            modalCameraSelect.value = currentIndex;
            await startModalCamera();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å†™çœŸã‚’æ’®å½±
        function captureModalPhoto() {
            const modalVideo = document.getElementById('modalVideo');
            const modalCanvas = document.getElementById('modalCanvas');
            const context = modalCanvas.getContext('2d');
            
            modalCanvas.width = modalVideo.videoWidth;
            modalCanvas.height = modalVideo.videoHeight;
            context.drawImage(modalVideo, 0, 0);
            
            modalCapturedImageData = modalCanvas.toDataURL('image/jpeg', 0.95);
            document.getElementById('modalCapturedImage').src = modalCapturedImageData;
            document.getElementById('modalCapturedImageContainer').classList.remove('hidden');
            
            stopModalCamera();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§æ’®ã‚Šç›´ã—
        function retakeModalPhoto() {
            modalCapturedImageData = null;
            document.getElementById('modalCapturedImageContainer').classList.add('hidden');
            startModalCamera();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã‚¯ãƒ­ãƒƒãƒ—
        function cropModalImage() {
            if (!modalCapturedImageData) {
                alert('ç”»åƒãŒæ’®å½±ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            alert('ã‚¯ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ã€‚ç¾åœ¨ã¯æ’®å½±ã—ãŸç”»åƒã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¾ã™ã€‚');
        }

        // AIã«è³ªå•ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openAIQuestionModal() {
            document.getElementById('aiQuestionModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // AIã«è³ªå•ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeAIQuestionModal() {
            document.getElementById('aiQuestionModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            stopModalCamera();
        }

        // AIã«è³ªå•ã‚’é€ä¿¡
        async function submitAIQuestion() {
            const question = document.getElementById('aiQuestion').value.trim();
            const appKey = document.getElementById('appKey').value.trim();
            const studentId = document.getElementById('studentId').value.trim();

            if (!question) {
                alert('è³ªå•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!appKey || !studentId) {
                alert('APP_KEYã¨IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const resultDiv = document.getElementById('aiResult');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div>AIãŒå›ç­”ã‚’ç”Ÿæˆä¸­...</div>';

            try {
                const formData = new FormData();
                formData.append('question', question);
                formData.append('studentId', studentId);
                
                if (modalCapturedImageData) {
                    const blob = dataURLtoBlob(modalCapturedImageData);
                    formData.append('image', blob, 'question_image.jpg');
                }

                const response = await fetch('/api/ai-question', {
                    method: 'POST',
                    headers: {
                        'X-APP-KEY': appKey
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }

                const data = await response.json();
                resultDiv.textContent = data.answer || 'AIã‹ã‚‰ã®å›ç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
            } catch (error) {
                console.error('AIè³ªå•ã‚¨ãƒ©ãƒ¼:', error);
                resultDiv.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
            }
        }

        // OCRã‚’å®Ÿè¡Œ
        async function performOCR() {
            const appKey = document.getElementById('appKey').value.trim();
            const studentId = document.getElementById('studentId').value.trim();

            if (!appKey || !studentId) {
                alert('APP_KEYã¨IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!capturedImageData) {
                alert('å…ˆã«å†™çœŸã‚’æ’®å½±ã—ã¦ãã ã•ã„');
                return;
            }

            const resultDiv = document.getElementById('ocrResult');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div>OCRå‡¦ç†ä¸­...</div>';

            try {
                const blob = dataURLtoBlob(capturedImageData);
                const formData = new FormData();
                formData.append('image', blob, 'ocr_image.jpg');
                formData.append('studentId', studentId);

                const response = await fetch('/api/ocr', {
                    method: 'POST',
                    headers: {
                        'X-APP-KEY': appKey
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }

                const data = await response.json();
                resultDiv.textContent = data.text || 'ãƒ†ã‚­ã‚¹ãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
            } catch (error) {
                console.error('OCRã‚¨ãƒ©ãƒ¼:', error);
                resultDiv.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
            }
        }

        // Data URLã‚’Blobã«å¤‰æ›
        function dataURLtoBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const modal = document.getElementById('aiQuestionModal');
            if (event.target === modal) {
                closeAIQuestionModal();
            }
        }
    </script>
</body>
</html>
