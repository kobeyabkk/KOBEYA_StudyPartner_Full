# è‹±æ¤œå•é¡Œç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ å¼·åŒ–ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

**ä½œæˆæ—¥**: 2025-11-11  
**ãƒ™ãƒ¼ã‚¹**: V3æ—¢å­˜å®Ÿè£… + 3AIçµ±åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆClaude, Gemini, ChatGPT, Gensparkï¼‰

---

## ğŸ“Š ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

### ç¾çŠ¶
- âœ… ç©ºæ‰€è£œå……å•é¡Œï¼ˆæ–‡æ³•ãƒ»èªå½™ï¼‰å®Ÿè£…æ¸ˆã¿
- âœ… è‘—ä½œæ¨©æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…æ¸ˆã¿
- âœ… å„ç´šã®æ–‡æ³•ãƒˆãƒ”ãƒƒã‚¯ãƒãƒƒãƒ”ãƒ³ã‚°å®Œäº†
- âœ… æ—¥æœ¬èªè§£èª¬ãƒ»ç¿»è¨³ç”Ÿæˆæ©Ÿèƒ½å®Œå‚™

### ä¸è¶³ã—ã¦ã„ã‚‹ä¸»è¦æ©Ÿèƒ½
1. ğŸ”´ **èªå½™ãƒ¬ãƒ™ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ **ï¼ˆ300èªï½15,000èªã®å³å¯†ãªåˆ¶å¾¡ï¼‰
2. ğŸ”´ **2024å¹´åº¦ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«å¯¾å¿œ**ï¼ˆè¦ç´„ãƒ»Eãƒ¡ãƒ¼ãƒ«å•é¡Œï¼‰
3. ğŸ”´ **å•é¡Œå½¢å¼ã®å¤šæ§˜åŒ–**ï¼ˆä¼šè©±æ–‡ã€é•·æ–‡èª­è§£ã€èªé †æ•´åºï¼‰
4. ğŸŸ¡ **ãƒˆãƒ”ãƒƒã‚¯åˆ†é‡ç®¡ç†**ï¼ˆå„ç´šã®æ¨å¥¨ãƒˆãƒ”ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼‰
5. ğŸŸ¡ **ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°è‡ªå‹•æ¡ç‚¹**ï¼ˆ4é …ç›®Ã—4ç‚¹ï¼16ç‚¹æº€ç‚¹ï¼‰

### å®Ÿè£…å„ªå…ˆåº¦ï¼ˆ3AIç·åˆåˆ¤æ–­ï¼‰
```
Phase 1: èªå½™ãƒ¬ãƒ™ãƒ«ç®¡ç†        [CRITICAL] ğŸ”¥ğŸ”¥ğŸ”¥
Phase 2: ãƒˆãƒ”ãƒƒã‚¯åˆ†é‡ç®¡ç†      [HIGH]     âš ï¸âš ï¸
Phase 3: å•é¡Œå½¢å¼å¤šæ§˜åŒ–ï¼ˆç°¡å˜ï¼‰ [HIGH]     âš ï¸
Phase 4: 2024å¹´åº¦å¯¾å¿œ          [HIGH]     âš ï¸
Phase 5: é•·æ–‡èª­è§£ãƒ»æ¡ç‚¹        [MEDIUM]   ğŸ“Œ
```

---

## ğŸ¯ Phase 1: èªå½™ãƒ¬ãƒ™ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€æœ€å„ªå…ˆã€‘

### ç›®æ¨™
å„ç´šã®èªå½™æ•°ç¯„å›²ï¼ˆ5ç´š:300-600èª ï½ 1ç´š:10,000-15,000èªï¼‰ã‚’å³å¯†ã«ç®¡ç†ã—ã€ç”Ÿæˆå•é¡Œã®èªå½™ãƒ¬ãƒ™ãƒ«ã‚’ä¿è¨¼ã™ã‚‹ã€‚

### æŠ€è¡“çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆ3AIçµ±åˆæ¡ˆï¼‰

#### A. èªå½™è¾æ›¸ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰

**æ¡ç”¨æ–¹é‡**: Claudeææ¡ˆã®ã€Œè¤‡æ•°ã‚½ãƒ¼ã‚¹çµ±åˆã€+ ChatGPTææ¡ˆã®ã€ŒCEFRÃ—é »åº¦ç®¡ç†ã€

```sql
-- æ–°ãƒ†ãƒ¼ãƒ–ãƒ«: èªå½™è¾æ›¸
CREATE TABLE IF NOT EXISTS eiken_vocabulary_lexicon (
    word_lemma TEXT NOT NULL,              -- è¦‹å‡ºã—èªï¼ˆåŸå‹ï¼‰
    pos TEXT NOT NULL,                     -- å“è© (noun/verb/adj/adv/...)
    cefr_level TEXT NOT NULL,              -- 'A1', 'A2', 'B1', 'B2', 'C1', 'C2'
    zipf_score REAL,                       -- é »åº¦ã‚¹ã‚³ã‚¢ (1.0-7.0)
    grade_level INTEGER,                   -- è‹±æ¤œç´š (5, 4, 3, 21, 2, 11, 1)
    
    -- ä¿¡é ¼æ€§ç®¡ç†
    sources TEXT NOT NULL,                 -- JSON: ["CEFR-J", "SVL", "NGSL"]
    confidence REAL NOT NULL DEFAULT 1.0,  -- è¤‡æ•°ã‚½ãƒ¼ã‚¹ä¸€è‡´åº¦ (0.0-1.0)
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    frequency_rank INTEGER,
    manual_verified INTEGER DEFAULT 0,     -- æ‰‹å‹•æ¤œè¨¼æ¸ˆã¿
    last_updated TEXT DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (word_lemma, pos),
    CHECK (cefr_level IN ('A1', 'A2', 'B1', 'B2', 'C1', 'C2')),
    CHECK (confidence >= 0.0 AND confidence <= 1.0),
    CHECK (manual_verified IN (0, 1)),
    CHECK (json_valid(sources))
);

CREATE INDEX idx_vocab_cefr ON eiken_vocabulary_lexicon(cefr_level);
CREATE INDEX idx_vocab_grade ON eiken_vocabulary_lexicon(grade_level);
CREATE INDEX idx_vocab_zipf ON eiken_vocabulary_lexicon(zipf_score);
CREATE INDEX idx_vocab_confidence ON eiken_vocabulary_lexicon(confidence);
```

**ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æˆ¦ç•¥**:
1. **CEFR-J**: æ—¥æœ¬ã®å­¦ç¿’è€…å‘ã‘ã«æœ€é©åŒ–
2. **SVL 12000**: æ—¥æœ¬ã§ãƒ¡ã‚¸ãƒ£ãƒ¼ã€æ•™è‚²ç¾å ´ã§åºƒãä½¿ç”¨
3. **NGSL/NAWL**: å›½éš›æ¨™æº–ã€å®Ÿç”¨çš„
4. **ã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: 3ã‚½ãƒ¼ã‚¹ã§ä¸€è‡´ã™ã‚‹èªå½™ã‚’é«˜ä¿¡é ¼åº¦ã¨ã—ã¦æ¡ç”¨

#### B. Lemmatizationï¼ˆåŸå‹åŒ–ï¼‰å®Ÿè£…

**æ¡ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: `compromise`ï¼ˆCloudflare Workersäº’æ›ã€è»½é‡ï¼‰

```typescript
// src/eiken/services/vocabulary-analyzer.ts

import nlp from 'compromise';

export interface VocabularyAnalysisResult {
  isValid: boolean;
  totalWords: number;
  uniqueWords: number;
  outOfRangeWords: string[];
  outOfRangeRatio: number;
  suggestion: string | null;
  zipfViolations: string[];
}

/**
 * ãƒ†ã‚­ã‚¹ãƒˆã®èªå½™ãƒ¬ãƒ™ãƒ«ã‚’åˆ†æ
 */
export async function analyzeVocabularyLevel(
  text: string,
  targetGrade: string,
  env: EikenEnv
): Promise<VocabularyAnalysisResult> {
  
  // 1. ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚º & Lemmatization
  const doc = nlp(text);
  const tokens = doc.terms().out('array');
  const lemmas = tokens.map(token => 
    doc.match(token).toInfinitive().out('text') || token.toLowerCase()
  );
  
  const uniqueLemmas = [...new Set(lemmas)];
  
  // 2. D1ã«ä¸€æ‹¬ã‚¯ã‚¨ãƒªï¼ˆé«˜é€ŸåŒ–ï¼‰
  const placeholders = uniqueLemmas.map(() => '?').join(',');
  const vocabData = await env.DB.prepare(`
    SELECT word_lemma, cefr_level, grade_level, zipf_score
    FROM eiken_vocabulary_lexicon
    WHERE word_lemma IN (${placeholders})
    ORDER BY confidence DESC
  `).bind(...uniqueLemmas).all();
  
  // 3. ãƒ¬ãƒ™ãƒ«åˆ¤å®š
  const vocabMap = new Map(
    vocabData.results.map(row => [row.word_lemma, row])
  );
  
  const targetCEFR = getTargetCEFR(targetGrade);
  const targetZipfMin = 3.5; // é »åº¦é–¾å€¤
  
  const outOfRange: string[] = [];
  const zipfViolations: string[] = [];
  
  for (const lemma of uniqueLemmas) {
    const vocabInfo = vocabMap.get(lemma);
    
    if (!vocabInfo) {
      // è¾æ›¸ã«ãªã„å˜èªï¼ˆå›ºæœ‰åè©ã€å°‚é–€ç”¨èªç­‰ï¼‰â†’ è¨±å®¹
      continue;
    }
    
    // CEFRè¶…éãƒã‚§ãƒƒã‚¯
    if (isAboveCEFR(vocabInfo.cefr_level, targetCEFR)) {
      outOfRange.push(lemma);
    }
    
    // é »åº¦ãƒã‚§ãƒƒã‚¯ï¼ˆä½é »åº¦èªã¯é¿ã‘ã‚‹ï¼‰
    if (vocabInfo.zipf_score && vocabInfo.zipf_score < targetZipfMin) {
      zipfViolations.push(lemma);
    }
  }
  
  const outOfRangeRatio = outOfRange.length / uniqueLemmas.length;
  const zipfViolationRatio = zipfViolations.length / uniqueLemmas.length;
  
  // 4. åˆ¤å®šï¼ˆ3%ãƒ«ãƒ¼ãƒ«ï¼‰
  const isValid = outOfRangeRatio < 0.03 && zipfViolationRatio < 0.05;
  
  return {
    isValid,
    totalWords: lemmas.length,
    uniqueWords: uniqueLemmas.length,
    outOfRangeWords: outOfRange,
    outOfRangeRatio,
    suggestion: !isValid
      ? `ä»¥ä¸‹ã®å˜èªã‚’${targetCEFR}ãƒ¬ãƒ™ãƒ«ã«ç½®ãæ›ãˆã¦ãã ã•ã„: ${outOfRange.slice(0, 5).join(', ')}`
      : null,
    zipfViolations
  };
}

function getTargetCEFR(grade: string): string {
  const mapping: Record<string, string> = {
    '5': 'A1',
    '4': 'A1',
    '3': 'A2',
    'pre2': 'A2',
    '2': 'B1',
    'pre1': 'B2',
    '1': 'C1'
  };
  return mapping[grade] || 'B1';
}

function isAboveCEFR(wordLevel: string, targetLevel: string): boolean {
  const levels = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
  return levels.indexOf(wordLevel) > levels.indexOf(targetLevel);
}
```

#### C. ç”Ÿæˆãƒ•ãƒ­ãƒ¼çµ±åˆï¼ˆäº‹å‰åˆ¶å¾¡ + äº‹å¾Œæ¤œè¨¼ï¼‰

```typescript
// src/eiken/services/question-generator.ts ã«è¿½åŠ 

/**
 * èªå½™åˆ¶ç´„ä»˜ãå•é¡Œç”Ÿæˆ
 */
async function generateQuestionWithVocabControl(
  request: QuestionGenerationRequest,
  env: EikenEnv
): Promise<GeneratedQuestion> {
  
  const maxRetries = 3;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    // 1. å•é¡Œç”Ÿæˆï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§èªå½™åˆ¶ç´„ã‚’æŒ‡å®šï¼‰
    const question = await generateSingleQuestion(request, null, env.OPENAI_API_KEY);
    
    // 2. èªå½™ãƒ¬ãƒ™ãƒ«æ¤œè¨¼
    const combinedText = `${question.questionText} ${question.choices.join(' ')}`;
    const analysis = await analyzeVocabularyLevel(combinedText, request.grade, env);
    
    if (analysis.isValid) {
      console.log(`âœ… Vocabulary check passed (attempt ${attempt})`);
      return question;
    }
    
    console.log(`âš ï¸ Vocabulary check failed (attempt ${attempt}): ${analysis.outOfRangeRatio * 100}% out of range`);
    
    // 3. ä¿®æ­£ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§å†ç”Ÿæˆ
    if (attempt < maxRetries) {
      const rewritePrompt = buildVocabRewritePrompt(
        question,
        analysis.outOfRangeWords,
        request.grade
      );
      
      // ä¿®æ­£ç‰ˆç”Ÿæˆï¼ˆæ¬¡ã®ãƒ«ãƒ¼ãƒ—ã§å†æ¤œè¨¼ï¼‰
      request.topicHints = [`REWRITE: ${analysis.suggestion}`];
    }
  }
  
  throw new Error('Failed to generate question within vocabulary constraints');
}

function buildVocabRewritePrompt(
  question: GeneratedQuestion,
  outOfRangeWords: string[],
  grade: string
): string {
  const targetCEFR = getTargetCEFR(grade);
  
  return `
VOCABULARY CONSTRAINT VIOLATION DETECTED.

Original question uses words beyond ${targetCEFR} level:
${outOfRangeWords.join(', ')}

REWRITE this question using simpler synonyms appropriate for ${targetCEFR} level.
Maintain the same grammar point and difficulty.

Original: ${question.questionText}

Requirements:
- Replace advanced words with ${targetCEFR}-level synonyms
- Keep the question structure identical
- Ensure choices remain grammatically correct
- Preserve the educational value

Output: Rewritten question in the same JSON format.
  `.trim();
}
```

### å®Ÿè£…ã‚¿ã‚¹ã‚¯

```typescript
const PHASE1_TASKS = [
  {
    id: 'P1-1',
    task: 'èªå½™è¾æ›¸ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ',
    file: 'migrations/0009_create_vocabulary_lexicon.sql',
    priority: 'CRITICAL',
    estimatedHours: 2
  },
  {
    id: 'P1-2',
    task: 'CEFR-J + SVL + NGSL ãƒ‡ãƒ¼ã‚¿çµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ',
    file: 'scripts/import-vocabulary-data.ts',
    priority: 'CRITICAL',
    estimatedHours: 6,
    notes: 'ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç¢ºèªå¿…é ˆ'
  },
  {
    id: 'P1-3',
    task: 'Vocabulary Analyzerå®Ÿè£…',
    file: 'src/eiken/services/vocabulary-analyzer.ts',
    priority: 'CRITICAL',
    estimatedHours: 4
  },
  {
    id: 'P1-4',
    task: 'compromise ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµ±åˆ',
    dependencies: ['npm install compromise'],
    priority: 'HIGH',
    estimatedHours: 2
  },
  {
    id: 'P1-5',
    task: 'ç”Ÿæˆãƒ•ãƒ­ãƒ¼çµ±åˆï¼ˆäº‹å‰ï¼‹äº‹å¾Œæ¤œè¨¼ï¼‰',
    file: 'src/eiken/services/question-generator.ts',
    priority: 'HIGH',
    estimatedHours: 4
  },
  {
    id: 'P1-6',
    task: 'KVã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°å®Ÿè£…',
    file: 'src/eiken/services/vocabulary-cache.ts',
    priority: 'MEDIUM',
    estimatedHours: 2,
    notes: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–'
  },
  {
    id: 'P1-7',
    task: 'ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆ3%ãƒ«ãƒ¼ãƒ«æ¤œè¨¼ï¼‰',
    file: 'tests/vocabulary-analyzer.test.ts',
    priority: 'HIGH',
    estimatedHours: 3
  }
];

// åˆè¨ˆè¦‹ç©: 23æ™‚é–“ï¼ˆç´„3å–¶æ¥­æ—¥ï¼‰
```

---

## ğŸ·ï¸ Phase 2: ãƒˆãƒ”ãƒƒã‚¯åˆ†é‡ç®¡ç†

### ç›®æ¨™
å„ç´šã®æ¨å¥¨ãƒˆãƒ”ãƒƒã‚¯åˆ†é‡ãƒªã‚¹ãƒˆã‚’å®Ÿè£…ã—ã€å•é¡Œç”Ÿæˆæ™‚ã«é©åˆ‡ãªãƒˆãƒ”ãƒƒã‚¯ã‚’é¸æŠã™ã‚‹ã€‚

### å®Ÿè£…å†…å®¹

```typescript
// æ–°ãƒ•ã‚¡ã‚¤ãƒ«: src/eiken/data/topic-areas.ts

export const topicAreasByGrade: Record<EikenGrade, TopicArea[]> = {
  '5': [
    { code: 'family', label: 'å®¶æ—', weight: 1.5 },
    { code: 'friends', label: 'å‹é”', weight: 1.5 },
    { code: 'school', label: 'å­¦æ ¡', weight: 2.0 },
    { code: 'hobbies', label: 'è¶£å‘³', weight: 1.2 },
    { code: 'sports', label: 'ã‚¹ãƒãƒ¼ãƒ„', weight: 1.0 },
    { code: 'movies', label: 'æ˜ ç”»', weight: 0.8 },
    { code: 'music', label: 'éŸ³æ¥½', weight: 0.8 },
    { code: 'food', label: 'é£Ÿã¹ç‰©', weight: 1.2 },
    { code: 'weather', label: 'å¤©æ°—', weight: 1.0 },
    { code: 'directions', label: 'é“æ¡ˆå†…', weight: 0.7 },
    { code: 'self-intro', label: 'è‡ªå·±ç´¹ä»‹', weight: 1.3 },
    { code: 'plans', label: 'ä¼‘æ—¥ã®äºˆå®š', weight: 1.0 }
  ],
  
  '4': [
    { code: 'school', label: 'å­¦æ ¡', weight: 1.5 },
    { code: 'local-community', label: 'åœ°åŸŸ', weight: 1.0 },
    { code: 'shopping', label: 'è²·ã„ç‰©', weight: 1.2 },
    { code: 'part-time', label: 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ', weight: 0.8 },
    { code: 'travel', label: 'æ—…è¡Œ', weight: 1.3 },
    { code: 'directions', label: 'é“æ¡ˆå†…', weight: 0.7 },
    { code: 'phone-conversation', label: 'é›»è©±ã§ã®ä¼šè©±', weight: 0.9 },
    { code: 'birthday', label: 'èª•ç”Ÿæ—¥', weight: 0.6 },
    { code: 'future-dreams', label: 'å°†æ¥ã®å¤¢', weight: 1.4 }
  ],
  
  '3': [
    { code: 'family', label: 'å®¶æ—', weight: 1.2 },
    { code: 'friends', label: 'å‹äºº', weight: 1.2 },
    { code: 'school', label: 'å­¦æ ¡', weight: 1.5 },
    { code: 'local-community', label: 'åœ°åŸŸ', weight: 1.0 },
    { code: 'phone', label: 'é›»è©±', weight: 0.8 },
    { code: 'shopping', label: 'è²·ã„ç‰©', weight: 1.0 },
    { code: 'travel', label: 'æ—…è¡Œ', weight: 1.3 },
    { code: 'directions', label: 'é“æ¡ˆå†…', weight: 0.7 },
    { code: 'sports', label: 'ã‚¹ãƒãƒ¼ãƒ„', weight: 1.0 },
    { code: 'movies', label: 'æ˜ ç”»', weight: 0.9 },
    { code: 'music', label: 'éŸ³æ¥½', weight: 0.9 },
    { code: 'cooking', label: 'æ–™ç†', weight: 0.8 },
    { code: 'weather', label: 'å¤©æ°—', weight: 0.7 }
  ],
  
  'pre2': [
    { code: 'school-life', label: 'å­¦æ ¡ç”Ÿæ´»', weight: 1.3 },
    { code: 'hobbies', label: 'è¶£å‘³', weight: 1.0 },
    { code: 'travel', label: 'æ—…è¡Œ', weight: 1.2 },
    { code: 'shopping', label: 'è²·ã„ç‰©', weight: 0.9 },
    { code: 'sports', label: 'ã‚¹ãƒãƒ¼ãƒ„', weight: 1.0 },
    { code: 'movies', label: 'æ˜ ç”»', weight: 0.8 },
    { code: 'volunteer', label: 'ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢æ´»å‹•', weight: 1.1 },
    { code: 'cultural-exchange', label: 'ç•°æ–‡åŒ–ç†è§£', weight: 1.3 },
    { code: 'science', label: 'ç§‘å­¦', weight: 1.0 },
    { code: 'nature-environment', label: 'è‡ªç„¶ãƒ»ç’°å¢ƒ', weight: 1.2 }
  ],
  
  '2': [
    { code: 'daily-life', label: 'æ—¥å¸¸ç”Ÿæ´»', weight: 1.0 },
    { code: 'school', label: 'å­¦æ ¡', weight: 1.0 },
    { code: 'work', label: 'ä»•äº‹', weight: 1.2 },
    { code: 'hobbies', label: 'è¶£å‘³', weight: 0.9 },
    { code: 'travel', label: 'æ—…è¡Œ', weight: 1.1 },
    { code: 'shopping', label: 'è²·ã„ç‰©', weight: 0.8 },
    { code: 'health', label: 'å¥åº·', weight: 1.2 },
    { code: 'sports', label: 'ã‚¹ãƒãƒ¼ãƒ„', weight: 0.9 },
    { code: 'volunteer', label: 'ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢', weight: 1.0 },
    { code: 'science', label: 'ç§‘å­¦', weight: 1.1 },
    { code: 'history', label: 'æ­´å²', weight: 1.0 },
    { code: 'education', label: 'æ•™è‚²', weight: 1.3 },
    { code: 'business', label: 'ãƒ“ã‚¸ãƒã‚¹', weight: 1.2 },
    { code: 'media', label: 'ãƒ¡ãƒ‡ã‚£ã‚¢', weight: 1.1 },
    { code: 'environment', label: 'ç’°å¢ƒ', weight: 1.3 }
  ],
  
  'pre1': [
    { code: 'science', label: 'ç§‘å­¦', weight: 1.3 },
    { code: 'medicine', label: 'åŒ»ç™‚', weight: 1.2 },
    { code: 'technology', label: 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼', weight: 1.4 },
    { code: 'business', label: 'ãƒ“ã‚¸ãƒã‚¹', weight: 1.3 },
    { code: 'politics', label: 'æ”¿æ²»', weight: 1.0 },
    { code: 'education', label: 'æ•™è‚²', weight: 1.2 },
    { code: 'history', label: 'æ­´å²', weight: 1.0 },
    { code: 'environment', label: 'ç’°å¢ƒ', weight: 1.4 },
    { code: 'arts', label: 'èŠ¸è¡“', weight: 0.9 },
    { code: 'psychology', label: 'å¿ƒç†å­¦', weight: 1.1 },
    { code: 'globalization', label: 'ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–', weight: 1.2 },
    { code: 'innovation', label: 'ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³', weight: 1.3 }
  ],
  
  '1': [
    { code: 'education', label: 'æ•™è‚²', weight: 1.2 },
    { code: 'science', label: 'ç§‘å­¦', weight: 1.3 },
    { code: 'technology', label: 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼', weight: 1.4 },
    { code: 'business', label: 'ãƒ“ã‚¸ãƒã‚¹', weight: 1.3 },
    { code: 'medicine', label: 'åŒ»ç™‚', weight: 1.2 },
    { code: 'environment', label: 'ç’°å¢ƒ', weight: 1.4 },
    { code: 'society', label: 'ç¤¾ä¼š', weight: 1.3 },
    { code: 'culture', label: 'æ–‡åŒ–', weight: 1.1 },
    { code: 'economics', label: 'çµŒæ¸ˆ', weight: 1.2 },
    { code: 'international-relations', label: 'å›½éš›é–¢ä¿‚', weight: 1.1 },
    { code: 'ethics', label: 'å€«ç†', weight: 1.0 },
    { code: 'philosophy', label: 'å“²å­¦', weight: 0.9 }
  ]
};

interface TopicArea {
  code: string;
  label: string;
  weight: number; // é¸æŠç¢ºç‡ã®é‡ã¿
}

/**
 * é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ ã§ãƒˆãƒ”ãƒƒã‚¯ã‚’é¸æŠ
 * ç›´è¿‘ä½¿ç”¨ã—ãŸãƒˆãƒ”ãƒƒã‚¯ã¯å›é¿
 */
export function selectRandomTopic(
  grade: EikenGrade,
  recentHistory: string[] = []
): TopicArea {
  
  const topics = topicAreasByGrade[grade];
  
  // ç›´è¿‘ä½¿ç”¨ãƒˆãƒ”ãƒƒã‚¯ã‚’é™¤å¤–
  const available = topics.filter(t => !recentHistory.includes(t.code));
  
  if (available.length === 0) {
    // å…¨ãƒˆãƒ”ãƒƒã‚¯ä½¿ç”¨æ¸ˆã¿ã®å ´åˆã¯ãƒªã‚»ãƒƒãƒˆ
    return weightedRandom(topics);
  }
  
  return weightedRandom(available);
}

function weightedRandom<T extends { weight: number }>(items: T[]): T {
  const totalWeight = items.reduce((sum, item) => sum + item.weight, 0);
  let random = Math.random() * totalWeight;
  
  for (const item of items) {
    random -= item.weight;
    if (random <= 0) {
      return item;
    }
  }
  
  return items[items.length - 1];
}
```

### ãƒˆãƒ”ãƒƒã‚¯ä½¿ç”¨å±¥æ­´ç®¡ç†

```sql
-- ãƒˆãƒ”ãƒƒã‚¯ä½¿ç”¨å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE IF NOT EXISTS eiken_topic_usage_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    grade TEXT NOT NULL,
    topic_code TEXT NOT NULL,
    question_id INTEGER NOT NULL,
    used_at TEXT DEFAULT CURRENT_TIMESTAMP,
    CHECK (grade IN ('5', '4', '3', 'pre2', '2', 'pre1', '1')),
    FOREIGN KEY (question_id) REFERENCES eiken_generated_questions(id) ON DELETE CASCADE
);

CREATE INDEX idx_topic_usage_grade_recent 
    ON eiken_topic_usage_history(grade, used_at DESC);
```

### å®Ÿè£…ã‚¿ã‚¹ã‚¯

```typescript
const PHASE2_TASKS = [
  {
    id: 'P2-1',
    task: 'ãƒˆãƒ”ãƒƒã‚¯åˆ†é‡å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ',
    file: 'src/eiken/data/topic-areas.ts',
    priority: 'HIGH',
    estimatedHours: 3
  },
  {
    id: 'P2-2',
    task: 'ãƒˆãƒ”ãƒƒã‚¯ä½¿ç”¨å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ',
    file: 'migrations/0010_create_topic_usage_history.sql',
    priority: 'MEDIUM',
    estimatedHours: 1
  },
  {
    id: 'P2-3',
    task: 'é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸æŠãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…',
    file: 'src/eiken/data/topic-areas.ts',
    priority: 'HIGH',
    estimatedHours: 2
  },
  {
    id: 'P2-4',
    task: 'å•é¡Œç”Ÿæˆæ™‚ã®ãƒˆãƒ”ãƒƒã‚¯çµ±åˆ',
    file: 'src/eiken/services/question-generator.ts',
    priority: 'HIGH',
    estimatedHours: 2
  },
  {
    id: 'P2-5',
    task: 'ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ',
    file: 'tests/topic-selection.test.ts',
    priority: 'MEDIUM',
    estimatedHours: 2
  }
];

// åˆè¨ˆè¦‹ç©: 10æ™‚é–“ï¼ˆç´„1.5å–¶æ¥­æ—¥ï¼‰
```

---

## ğŸ—£ï¸ Phase 3: å•é¡Œå½¢å¼ã®å¤šæ§˜åŒ–ï¼ˆç°¡å˜ãªå½¢å¼ã‹ã‚‰ï¼‰

### ç›®æ¨™
ç©ºæ‰€è£œå……ä»¥å¤–ã®å•é¡Œå½¢å¼ã‚’æ®µéšçš„ã«è¿½åŠ ã™ã‚‹ã€‚

### å®Ÿè£…é †åº

#### 3-1. ä¼šè©±æ–‡ç©ºæ‰€è£œå……ï¼ˆæœ€ã‚‚ç°¡å˜ï¼‰

```typescript
// src/eiken/services/conversation-generator.ts

export interface ConversationQuestion extends GeneratedQuestion {
  conversationType: 'daily' | 'phone' | 'shopping' | 'direction';
  speakers: string[];
}

async function generateConversationQuestion(
  request: QuestionGenerationRequest,
  env: EikenEnv
): Promise<ConversationQuestion> {
  
  const topic = selectRandomTopic(request.grade);
  const targetCEFR = getTargetCEFR(request.grade);
  
  const prompt = `
Generate a CONVERSATION fill-in-the-blank question for Eiken Grade ${request.grade}.

Requirements:
- Topic: ${topic.label}
- CEFR Level: ${targetCEFR}
- Create a realistic dialogue between 2-3 people
- Insert ( ) blank in a natural conversation point
- Test appropriate language functions (greeting, asking, suggesting, etc.)
- Provide 4 choices that fit grammatically but only one fits contextually

Format:
Speaker A: [First speaker's line]
Speaker B: [Second speaker's line with ( ) blank]
Speaker A: [Response]

Output JSON:
{
  "speakers": ["A", "B"],
  "conversation_type": "daily",
  "question_text": "Full conversation with ( ) blank",
  "choices": ["option1", "option2", "option3", "option4"],
  "correct_answer_index": 0,
  "explanation": "Why this answer is correct",
  "explanation_ja": "æ­£è§£ã®ç†ç”±",
  "translation_ja": "ä¼šè©±ã®æ—¥æœ¬èªè¨³"
}
  `.trim();
  
  // OpenAI APIå‘¼ã³å‡ºã—ï¼ˆæ—¢å­˜ã® generateSingleQuestion ã‚’æµç”¨ï¼‰
  // ...
}
```

#### 3-2. èªé †æ•´åºå•é¡Œï¼ˆ3ç´šä»¥ä¸‹ï¼‰

```typescript
// src/eiken/services/reorder-generator.ts

export interface ReorderQuestion {
  questionNumber: number;
  japaneseSentence: string;
  englishWords: string[];
  correctOrder: number[];
  extraWordIndex: number;
  explanation: string;
  explanationJa: string;
  difficulty: number;
}

async function generateReorderQuestion(
  request: QuestionGenerationRequest,
  env: EikenEnv
): Promise<ReorderQuestion> {
  
  // 3ç´šä»¥ä¸‹ã®ã¿å¯¾å¿œ
  if (!['5', '4', '3'].includes(request.grade)) {
    throw new Error('Reorder questions are only for grades 5, 4, and 3');
  }
  
  const topic = selectRandomTopic(request.grade);
  const targetCEFR = getTargetCEFR(request.grade);
  
  const prompt = `
Generate a SENTENCE ORDERING question for Eiken Grade ${request.grade}.

Requirements:
- Topic: ${topic.label}
- CEFR Level: ${targetCEFR}
- Provide a Japanese sentence to translate
- Give 5-6 English word/phrase cards in random order
- One card is extra (not needed)
- Student must select 4 cards and arrange them correctly

Example:
Japanese: ã€Œå½¼ã¯æ˜¨æ—¥å…¬åœ’ã§çŠ¬ã¨éŠã‚“ã§ã„ã¾ã—ãŸã€‚ã€
Cards: [1. playing  2. in the park  3. with his dog  4. yesterday  5. was  6. has been]
Correct order: 5 â†’ 1 â†’ 2 â†’ 3 (cards 5, 1, 2, 3)
Extra card: 6

Output JSON:
{
  "japanese_sentence": "æ—¥æœ¬èªã®æ–‡",
  "english_words": ["word1", "word2", "word3", "word4", "word5", "word6"],
  "correct_order": [4, 0, 1, 2],
  "extra_word_index": 5,
  "explanation": "Grammar explanation",
  "explanation_ja": "æ–‡æ³•èª¬æ˜"
}
  `.trim();
  
  // ...
}
```

### å®Ÿè£…ã‚¿ã‚¹ã‚¯

```typescript
const PHASE3_TASKS = [
  {
    id: 'P3-1',
    task: 'ä¼šè©±æ–‡ç”Ÿæˆã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…',
    file: 'src/eiken/services/conversation-generator.ts',
    priority: 'HIGH',
    estimatedHours: 4
  },
  {
    id: 'P3-2',
    task: 'èªé †æ•´åºç”Ÿæˆã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…',
    file: 'src/eiken/services/reorder-generator.ts',
    priority: 'HIGH',
    estimatedHours: 4
  },
  {
    id: 'P3-3',
    task: 'QuestionTypeå‹å®šç¾©æ‹¡å¼µ',
    file: 'src/eiken/types.ts',
    priority: 'HIGH',
    estimatedHours: 1
  },
  {
    id: 'P3-4',
    task: 'ã‚¹ã‚­ãƒ¼ãƒæ‹¡å¼µï¼ˆå•é¡Œå½¢å¼å¯¾å¿œï¼‰',
    file: 'migrations/0011_extend_question_types.sql',
    priority: 'MEDIUM',
    estimatedHours: 2
  },
  {
    id: 'P3-5',
    task: 'ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ',
    file: 'tests/conversation-reorder.test.ts',
    priority: 'MEDIUM',
    estimatedHours: 3
  }
];

// åˆè¨ˆè¦‹ç©: 14æ™‚é–“ï¼ˆç´„2å–¶æ¥­æ—¥ï¼‰
```

---

## ğŸ“ Phase 4: 2024å¹´åº¦ãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«å¯¾å¿œ

### ç›®æ¨™
ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°å•é¡Œï¼ˆè¦ç´„ãƒ»Eãƒ¡ãƒ¼ãƒ«ï¼‰ã¨è‡ªå‹•æ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã™ã‚‹ã€‚

### 4-1. ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°å•é¡Œç”Ÿæˆ

#### è¦ç´„å•é¡Œï¼ˆæº–1ç´šãƒ»2ç´šï¼‰

```typescript
// src/eiken/services/writing-summary-generator.ts

export interface SummaryWritingTask {
  passage: string;
  passageWordCount: number;
  instruction: string;
  wordLimit: { min: number; max: number };
  rubric: ScoringRubric;
  topic: string;
  difficulty: number;
}

async function generateSummaryTask(
  grade: '2' | 'pre1',
  env: EikenEnv
): Promise<SummaryWritingTask> {
  
  const topic = selectRandomTopic(grade);
  const wordLimit = grade === 'pre1' 
    ? { min: 45, max: 55 } 
    : { min: 60, max: 70 };
  
  const passageLength = grade === 'pre1' ? '90-120' : '90-120';
  
  const prompt = `
Generate a SUMMARY writing task for Eiken Grade ${grade}.

Requirements:
- Provide a ${passageLength} word English passage on topic: ${topic.label}
- The passage should present 2-3 main points clearly
- Ask the examinee to summarize in ${wordLimit.min}-${wordLimit.max} words
- Topic should be appropriate for ${grade === 'pre1' ? 'Pre-1' : 'Grade 2'} level

Output JSON:
{
  "passage": "Original English passage (${passageLength} words)",
  "passage_word_count": 100,
  "instruction": "Task instruction in Japanese",
  "word_limit": { "min": ${wordLimit.min}, "max": ${wordLimit.max} },
  "main_points": ["point1", "point2", "point3"],
  "sample_answer": "Example summary (for reference only, not shown to students)",
  "topic": "${topic.code}"
}
  `.trim();
  
  // OpenAI APIå‘¼ã³å‡ºã—
  // ...
}
```

#### Eãƒ¡ãƒ¼ãƒ«å•é¡Œï¼ˆæº–2ç´šãƒ»3ç´šï¼‰

```typescript
// src/eiken/services/writing-email-generator.ts

export interface EmailWritingTask {
  situation: string;
  receivedEmail: string;
  requiredPoints: string[];
  instruction: string;
  rubric: ScoringRubric;
  topic: string;
}

async function generateEmailTask(
  grade: '3' | 'pre2',
  env: EikenEnv
): Promise<EmailWritingTask> {
  
  const topic = selectRandomTopic(grade);
  
  const prompt = `
Generate an EMAIL writing task for Eiken Grade ${grade}.

Requirements:
- Create a realistic situation where the student receives an email
- The email should be from a friend, teacher, or acquaintance
- Provide 2 required points that must be included in the reply
- Task should be appropriate for ${grade === 'pre2' ? 'Pre-2' : 'Grade 3'} level

Output JSON:
{
  "situation": "Situation description in Japanese",
  "received_email": "Email content in English",
  "sender_name": "Name of the sender",
  "required_points": [
    "Point 1 that must be included in the reply",
    "Point 2 that must be included in the reply"
  ],
  "instruction": "Task instruction in Japanese",
  "sample_answer": "Example reply (for reference only)",
  "topic": "${topic.code}"
}
  `.trim();
  
  // ...
}
```

### 4-2. è‡ªå‹•æ¡ç‚¹ã‚·ã‚¹ãƒ†ãƒ 

**æ¡ç”¨æ–¹é‡**: Geminiææ¡ˆã®ã€Œãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯æ˜ç¤ºå‹ã€+ ChatGPTææ¡ˆã®ã€Œæ ¹æ‹ æŠ½å‡ºâ†’æ¡ç‚¹ã€

```typescript
// src/eiken/services/writing-scorer.ts

export interface ScoringRubric {
  criteria: ScoringCriterion[];
  totalScore: number;
}

export interface ScoringCriterion {
  name: string;
  nameEn: string;
  maxScore: number;
  description: string;
  levels: Record<number, string>;
}

export interface ScoringResult {
  scores: Record<string, number>;
  totalScore: number;
  maxScore: number;
  feedback: Record<string, string>;
  evidence: Record<string, string>;
  confidence: number;
}

// ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯å®šç¾©
export const WRITING_RUBRICS: Record<string, ScoringRubric> = {
  opinion: {
    criteria: [
      {
        name: 'å†…å®¹',
        nameEn: 'Content',
        maxScore: 4,
        description: 'èª²é¡Œã§æ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹å†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹',
        levels: {
          4: 'èª²é¡Œã®è¦æ±‚ã‚’ååˆ†æº€ãŸã—ã¦ã„ã‚‹',
          3: 'ã»ã¼æº€ãŸã—ã¦ã„ã‚‹ãŒä¸€éƒ¨ä¸è¶³',
          2: 'èª²é¡Œã®è¦æ±‚ã®ä¸€éƒ¨ã—ã‹æº€ãŸã—ã¦ã„ãªã„',
          1: 'èª²é¡Œã®è¦æ±‚ã‚’ã»ã¨ã‚“ã©æº€ãŸã—ã¦ã„ãªã„',
          0: 'ç­”æ¡ˆãªã—'
        }
      },
      {
        name: 'æ§‹æˆ',
        nameEn: 'Coherence',
        maxScore: 4,
        description: 'è‹±æ–‡ã®æ§‹æˆã‚„æµã‚ŒãŒã‚ã‹ã‚Šã‚„ã™ãè«–ç†çš„ã‹',
        levels: {
          4: 'è«–ç†çš„ãªæ§‹æˆã§ã€æµã‚ŒãŒã‚¹ãƒ ãƒ¼ã‚º',
          3: 'æ¦‚ã­è«–ç†çš„ã ãŒã€ä¸€éƒ¨ä¸æ˜ç­',
          2: 'æ§‹æˆãŒä¸ååˆ†ã§ã€æµã‚ŒãŒæ‚ªã„',
          1: 'æ§‹æˆãŒã»ã¨ã‚“ã©ãªã„',
          0: 'ç­”æ¡ˆãªã—'
        }
      },
      {
        name: 'èªå½™',
        nameEn: 'Vocabulary',
        maxScore: 4,
        description: 'èª²é¡Œã«ç›¸å¿œã—ã„èªå½™ã‚’æ­£ã—ãä½¿ãˆã¦ã„ã‚‹ã‹',
        levels: {
          4: 'è±Šå¯Œã§é©åˆ‡ãªèªå½™ã‚’ä½¿ç”¨',
          3: 'æ¦‚ã­é©åˆ‡ã ãŒã€ä¸€éƒ¨ä¸é©åˆ‡',
          2: 'èªå½™ãŒé™å®šçš„ã¾ãŸã¯ä¸é©åˆ‡',
          1: 'èªå½™ãŒéå¸¸ã«é™å®šçš„',
          0: 'ç­”æ¡ˆãªã—'
        }
      },
      {
        name: 'æ–‡æ³•',
        nameEn: 'Grammar',
        maxScore: 4,
        description: 'æ–‡æ§‹é€ ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãã‚Œã‚‰ã‚’æ­£ã—ãä½¿ãˆã¦ã„ã‚‹ã‹',
        levels: {
          4: 'å¤šæ§˜ãªæ–‡æ§‹é€ ã‚’æ­£ç¢ºã«ä½¿ç”¨',
          3: 'æ¦‚ã­æ­£ç¢ºã ãŒã€ä¸€éƒ¨èª¤ã‚Šã‚ã‚Š',
          2: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼ãŒç›®ç«‹ã¤',
          1: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼ãŒéå¸¸ã«å¤šã„',
          0: 'ç­”æ¡ˆãªã—'
        }
      }
    ],
    totalScore: 16
  },
  
  summary: {
    criteria: [
      {
        name: 'å†…å®¹',
        nameEn: 'Content',
        maxScore: 4,
        description: 'æ–‡ç« ã®è¦ç‚¹ã‚’æ‰ãˆã¦ã„ã‚‹ã‹',
        levels: {
          4: 'ä¸»è¦ãªè¦ç‚¹ã‚’ã™ã¹ã¦å«ã‚€',
          3: 'ã»ã¨ã‚“ã©ã®è¦ç‚¹ã‚’å«ã‚€ãŒä¸€éƒ¨æ¬ è½',
          2: 'è¦ç‚¹ã®ä¸€éƒ¨ã®ã¿',
          1: 'è¦ç‚¹ã‚’ã»ã¨ã‚“ã©æ‰ãˆã¦ã„ãªã„',
          0: 'ç­”æ¡ˆãªã—'
        }
      },
      {
        name: 'æ§‹æˆ',
        nameEn: 'Coherence',
        maxScore: 4,
        description: 'è«–ç†ã®æµã‚ŒãŒã‚ã‹ã‚Šã‚„ã™ãä¸€è²«æ€§ãŒã‚ã‚‹ã‹',
        levels: {
          4: 'è«–ç†çš„ã§ä¸€è²«æ€§ã®ã‚ã‚‹è¦ç´„',
          3: 'æ¦‚ã­ä¸€è²«ã—ã¦ã„ã‚‹ãŒä¸€éƒ¨ä¸æ˜ç­',
          2: 'è«–ç†ã®æµã‚ŒãŒä¸ååˆ†',
          1: 'ã»ã¨ã‚“ã©ä¸€è²«æ€§ãŒãªã„',
          0: 'ç­”æ¡ˆãªã—'
        }
      },
      {
        name: 'èªå½™',
        nameEn: 'Vocabulary',
        maxScore: 4,
        description: 'é©åˆ‡ãªèªå½™ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹',
        levels: {
          4: 'é©åˆ‡ã§å¤šæ§˜ãªèªå½™',
          3: 'æ¦‚ã­é©åˆ‡ã ãŒä¸€éƒ¨ä¸é©åˆ‡',
          2: 'èªå½™ãŒé™å®šçš„',
          1: 'èªå½™ãŒéå¸¸ã«é™å®šçš„',
          0: 'ç­”æ¡ˆãªã—'
        }
      },
      {
        name: 'æ–‡æ³•',
        nameEn: 'Grammar',
        maxScore: 4,
        description: 'æ­£ç¢ºã«æ–‡æ³•ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹',
        levels: {
          4: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼ãŒã»ã¨ã‚“ã©ãªã„',
          3: 'è»½å¾®ãªæ–‡æ³•ã‚¨ãƒ©ãƒ¼',
          2: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼ãŒç›®ç«‹ã¤',
          1: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼ãŒéå¸¸ã«å¤šã„',
          0: 'ç­”æ¡ˆãªã—'
        }
      }
    ],
    totalScore: 16
  },
  
  email: {
    criteria: [
      {
        name: 'å†…å®¹',
        nameEn: 'Content',
        maxScore: 4,
        description: 'æŒ‡å®šã•ã‚ŒãŸ2ã¤ã®ãƒã‚¤ãƒ³ãƒˆãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹',
        levels: {
          4: '2ã¤ã®ãƒã‚¤ãƒ³ãƒˆã‚’ååˆ†ã«è¨˜è¿°',
          3: '2ã¤ã®ãƒã‚¤ãƒ³ãƒˆã‚’å«ã‚€ãŒä¸€éƒ¨ä¸è¶³',
          2: '1ã¤ã®ãƒã‚¤ãƒ³ãƒˆã®ã¿ã€ã¾ãŸã¯ä¸ååˆ†',
          1: 'ãƒã‚¤ãƒ³ãƒˆãŒã»ã¨ã‚“ã©å«ã¾ã‚Œã¦ã„ãªã„',
          0: 'ç­”æ¡ˆãªã—'
        }
      },
      {
        name: 'æ§‹æˆ',
        nameEn: 'Coherence',
        maxScore: 4,
        description: 'Eãƒ¡ãƒ¼ãƒ«ã®å½¢å¼ãŒé©åˆ‡ã§ã€æµã‚ŒãŒè‡ªç„¶ã‹',
        levels: {
          4: 'é©åˆ‡ãªå½¢å¼ã§è‡ªç„¶ãªæµã‚Œ',
          3: 'æ¦‚ã­é©åˆ‡ã ãŒä¸€éƒ¨ä¸è‡ªç„¶',
          2: 'å½¢å¼ã‚„æµã‚ŒãŒä¸ååˆ†',
          1: 'ã»ã¨ã‚“ã©é©åˆ‡ã§ãªã„',
          0: 'ç­”æ¡ˆãªã—'
        }
      },
      {
        name: 'èªå½™',
        nameEn: 'Vocabulary',
        maxScore: 4,
        description: 'Eãƒ¡ãƒ¼ãƒ«ã«é©ã—ãŸèªå½™ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹',
        levels: {
          4: 'é©åˆ‡ã§è‡ªç„¶ãªèªå½™',
          3: 'æ¦‚ã­é©åˆ‡ã ãŒä¸€éƒ¨ä¸é©åˆ‡',
          2: 'èªå½™ãŒé™å®šçš„ã¾ãŸã¯ä¸é©åˆ‡',
          1: 'èªå½™ãŒéå¸¸ã«é™å®šçš„',
          0: 'ç­”æ¡ˆãªã—'
        }
      },
      {
        name: 'æ–‡æ³•',
        nameEn: 'Grammar',
        maxScore: 4,
        description: 'æ–‡æ³•çš„ã«æ­£ã—ã„è‹±æ–‡ãŒæ›¸ã‘ã¦ã„ã‚‹ã‹',
        levels: {
          4: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼ãŒã»ã¨ã‚“ã©ãªã„',
          3: 'è»½å¾®ãªæ–‡æ³•ã‚¨ãƒ©ãƒ¼',
          2: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼ãŒç›®ç«‹ã¤',
          1: 'æ–‡æ³•ã‚¨ãƒ©ãƒ¼ãŒéå¸¸ã«å¤šã„',
          0: 'ç­”æ¡ˆãªã—'
        }
      }
    ],
    totalScore: 16
  }
};

/**
 * ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°è‡ªå‹•æ¡ç‚¹ï¼ˆ2æ®µéšæ–¹å¼ï¼‰
 */
export async function scoreWriting(
  answer: string,
  task: SummaryWritingTask | EmailWritingTask,
  rubricType: 'opinion' | 'summary' | 'email',
  env: EikenEnv
): Promise<ScoringResult> {
  
  const rubric = WRITING_RUBRICS[rubricType];
  
  // Step 1: æ ¹æ‹ æŠ½å‡ºï¼ˆå„åŸºæº–ã”ã¨ã«è©²å½“ç®‡æ‰€ã‚’å¼•ç”¨ï¼‰
  const evidencePrompt = buildEvidenceExtractionPrompt(answer, task, rubric);
  const evidenceResponse = await callOpenAI(evidencePrompt, env.OPENAI_API_KEY);
  const evidence = JSON.parse(evidenceResponse);
  
  // Step 2: æ¡ç‚¹ï¼ˆæ ¹æ‹ ã«åŸºã¥ã„ã¦ç‚¹æ•°ä»˜ä¸ï¼‰
  const scoringPrompt = buildScoringPrompt(answer, task, rubric, evidence);
  const scoringResponse = await callOpenAI(scoringPrompt, env.OPENAI_API_KEY);
  const scoring = JSON.parse(scoringResponse);
  
  return {
    scores: scoring.scores,
    totalScore: Object.values(scoring.scores).reduce((a: number, b: number) => a + b, 0) as number,
    maxScore: rubric.totalScore,
    feedback: scoring.feedback,
    evidence: evidence,
    confidence: scoring.confidence || 0.8
  };
}

function buildEvidenceExtractionPrompt(
  answer: string,
  task: any,
  rubric: ScoringRubric
): string {
  return `
You are an EIKEN writing examiner. Extract evidence from the student's answer for each scoring criterion.

# Rubric
${JSON.stringify(rubric.criteria, null, 2)}

# Task
${JSON.stringify(task, null, 2)}

# Student's Answer
${answer}

# Your Task
For each criterion, extract specific quotes from the student's answer that demonstrate their performance.

Output JSON:
{
  "content": "Quote demonstrating content quality",
  "coherence": "Quote demonstrating coherence",
  "vocabulary": "Quote demonstrating vocabulary usage",
  "grammar": "Quote demonstrating grammar usage"
}
  `.trim();
}

function buildScoringPrompt(
  answer: string,
  task: any,
  rubric: ScoringRubric,
  evidence: Record<string, string>
): string {
  return `
You are an EIKEN writing examiner. Score the student's answer based on the rubric and extracted evidence.

# Rubric
${JSON.stringify(rubric, null, 2)}

# Task
${JSON.stringify(task, null, 2)}

# Student's Answer
${answer}

# Extracted Evidence
${JSON.stringify(evidence, null, 2)}

# Your Task
Score each criterion (0-4 points) based on the rubric levels.
Provide specific feedback for each criterion in Japanese.

Output JSON:
{
  "scores": {
    "content": 3,
    "coherence": 4,
    "vocabulary": 2,
    "grammar": 3
  },
  "feedback": {
    "content": "è¦ç´„ã®ãƒã‚¤ãƒ³ãƒˆAã¯å«ã¾ã‚Œã¦ã„ã¾ã—ãŸãŒã€BãŒä¸è¶³ã—ã¦ã„ã¾ã—ãŸã€‚",
    "coherence": "è«–ç†çš„ãªæµã‚Œã§ã€æ¥ç¶šè©ã‚‚é©åˆ‡ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚",
    "vocabulary": "ã€Œgoodã€ã‚„ã€Œniceã€ã®å¤šç”¨ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚ä»£ã‚ã‚Šã«ã€Œeffectiveã€ã‚„ã€Œsuitableã€ãªã©ã®èªå½™ã‚‚ä½¿ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
    "grammar": "æ™‚åˆ¶ã®ä½¿ã„æ–¹ã¯æ¦‚ã­æ­£ç¢ºã§ã™ã€‚ãŸã ã—ã€3ç®‡æ‰€ã§å† è©ã®èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚"
  },
  "confidence": 0.85
}
  `.trim();
}
```

### å®Ÿè£…ã‚¿ã‚¹ã‚¯

```typescript
const PHASE4_TASKS = [
  {
    id: 'P4-1',
    task: 'è¦ç´„å•é¡Œç”Ÿæˆã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…',
    file: 'src/eiken/services/writing-summary-generator.ts',
    priority: 'HIGH',
    estimatedHours: 6
  },
  {
    id: 'P4-2',
    task: 'Eãƒ¡ãƒ¼ãƒ«å•é¡Œç”Ÿæˆã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…',
    file: 'src/eiken/services/writing-email-generator.ts',
    priority: 'HIGH',
    estimatedHours: 5
  },
  {
    id: 'P4-3',
    task: 'ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯å®šç¾©',
    file: 'src/eiken/data/writing-rubrics.ts',
    priority: 'CRITICAL',
    estimatedHours: 3
  },
  {
    id: 'P4-4',
    task: 'è‡ªå‹•æ¡ç‚¹ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…ï¼ˆ2æ®µéšæ–¹å¼ï¼‰',
    file: 'src/eiken/services/writing-scorer.ts',
    priority: 'CRITICAL',
    estimatedHours: 8
  },
  {
    id: 'P4-5',
    task: 'ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ',
    file: 'migrations/0012_extend_writing_system.sql',
    priority: 'HIGH',
    estimatedHours: 2
  },
  {
    id: 'P4-6',
    task: 'æ¡ç‚¹ç²¾åº¦æ¤œè¨¼ï¼ˆäººé–“è©•ä¾¡ã¨ã®æ¯”è¼ƒï¼‰',
    file: 'tests/writing-scorer-accuracy.test.ts',
    priority: 'HIGH',
    estimatedHours: 6,
    notes: 'ç›®æ¨™: 80%ä»¥ä¸Šã®ä¸€è‡´ç‡'
  }
];

// åˆè¨ˆè¦‹ç©: 30æ™‚é–“ï¼ˆç´„4å–¶æ¥­æ—¥ï¼‰
```

---

## ğŸ“š Phase 5: é•·æ–‡èª­è§£å•é¡Œï¼ˆæœ€ã‚‚è¤‡é›‘ï¼‰

### ç›®æ¨™
é•·æ–‡ãƒ‘ãƒƒã‚»ãƒ¼ã‚¸ + å†…å®¹ä¸€è‡´å•é¡Œã‚’é«˜å“è³ªã«ç”Ÿæˆã™ã‚‹ã€‚

### æ¡ç”¨æ–¹é‡: Chain of Generationï¼ˆ3æ®µéšç”Ÿæˆï¼‰

**æ ¹æ‹ **: 3ã¤ã®AIãŒã™ã¹ã¦æ¨å¥¨ã€‚å“è³ªå‘ä¸Šã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚³ã‚¹ãƒˆå¢—ã‚’ä¸Šå›ã‚‹ã€‚

```typescript
// src/eiken/services/reading-comprehension-generator.ts

export interface ReadingComprehensionSet {
  passage: string;
  wordCount: number;
  passageType: 'expository' | 'narrative' | 'argumentative';
  questions: ReadingQuestion[];
  topic: string;
  difficulty: number;
}

export interface ReadingQuestion {
  questionNumber: number;
  questionText: string;
  choices: string[];
  correctAnswerIndex: number;
  explanation: string;
  explanationJa: string;
  evidenceQuote: string;
  questionType: 'main_idea' | 'detail' | 'inference' | 'vocabulary_in_context';
}

/**
 * Chain of Generation: 3æ®µéšã§é•·æ–‡å•é¡Œã‚»ãƒƒãƒˆã‚’ç”Ÿæˆ
 */
export class ChainedReadingGenerator {
  
  /**
   * Step 1: ãƒ‘ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
   */
  static async generatePassage(
    grade: EikenGrade,
    topic: string,
    wordCount: number,
    env: EikenEnv
  ): Promise<string> {
    
    const targetCEFR = getTargetCEFR(grade);
    
    const prompt = `
Generate a reading comprehension passage for Eiken Grade ${grade}.

Topic: ${topic}
Word count: ${wordCount} words
CEFR Level: ${targetCEFR}

**IMPORTANT**: 
- This passage will be used to create 3 content-based questions later
- Include 3 or more clear main points
- Place important information in each paragraph
- Use natural, authentic language appropriate for the level

Output: Plain text passage only (no JSON, no extra formatting)
    `.trim();
    
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${env.OPENAI_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          { role: 'system', content: 'You are an EIKEN passage writer.' },
          { role: 'user', content: prompt }
        ],
        temperature: 0.7
      }),
    });
    
    const data = await response.json();
    return data.choices[0].message.content;
  }
  
  /**
   * Step 2: è³ªå•ã¨æ­£ç­”ã®ç”Ÿæˆ
   */
  static async generateQuestionsWithAnswers(
    passage: string,
    questionCount: number,
    env: EikenEnv
  ): Promise<QuestionDraft[]> {
    
    const prompt = `
Create ${questionCount} content-based questions for this passage.

# Passage
${passage}

# Requirements
For each question, provide:
1. Question text
2. Quote from the passage that supports the answer
3. Correct answer text (not the full choice yet)
4. Question type (main_idea, detail, inference, vocabulary_in_context)

# Output Format (JSON array)
[
  {
    "question_number": 1,
    "question_text": "What is the main purpose of this passage?",
    "evidence_quote": "Quote from the passage",
    "correct_answer_text": "Text of the correct choice",
    "question_type": "main_idea"
  },
  {
    "question_number": 2,
    ...
  }
]

**IMPORTANT**: 
- Questions must be answerable from the passage
- Provide evidence_quote to justify the answer
    `.trim();
    
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${env.OPENAI_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          { role: 'system', content: 'You are an EIKEN question writer.' },
          { role: 'user', content: prompt }
        ],
        temperature: 0.5,
        response_format: { type: 'json_object' }
      }),
    });
    
    const data = await response.json();
    const result = JSON.parse(data.choices[0].message.content);
    return Array.isArray(result) ? result : result.questions || [];
  }
  
  /**
   * Step 3: èª¤ç­”é¸æŠè‚¢ï¼ˆDistractorï¼‰ã®ç”Ÿæˆ
   */
  static async generateDistractors(
    passage: string,
    question: QuestionDraft,
    env: EikenEnv
  ): Promise<string[]> {
    
    const prompt = `
This is a reading comprehension question with a pre-determined correct answer.

# Passage
${passage}

# Question
${question.question_text}

# Correct Answer (FIXED)
${question.correct_answer_text}

# Your Task
Generate 3 INCORRECT but plausible answer choices (distractors).

# Good Distractor Criteria
1. Grammatically correct
2. Seems plausible at first glance
3. BUT contradicts the passage content
4. Exploits common student errors (partially correct, easily confused, etc.)

# Output Format (JSON)
{
  "distractors": [
    "Incorrect choice 1",
    "Incorrect choice 2",
    "Incorrect choice 3"
  ],
  "rationale": {
    "1": "Why this is incorrect",
    "2": "Why this is incorrect",
    "3": "Why this is incorrect"
  }
}
    `.trim();
    
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${env.OPENAI_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          {
            role: 'system',
            content: 'You are an expert in creating plausible but incorrect answer choices.'
          },
          { role: 'user', content: prompt }
        ],
        temperature: 0.7,
        response_format: { type: 'json_object' }
      }),
    });
    
    const data = await response.json();
    const result = JSON.parse(data.choices[0].message.content);
    return result.distractors;
  }
  
  /**
   * å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
   */
  static async generateCompleteReadingSet(
    grade: EikenGrade,
    topic: string,
    questionCount: number,
    env: EikenEnv
  ): Promise<ReadingComprehensionSet> {
    
    console.log('ğŸ“– Step 1: Generating passage...');
    const passage = await this.generatePassage(
      grade,
      topic,
      this.getWordCount(grade),
      env
    );
    
    console.log('â“ Step 2: Generating questions with answers...');
    const questionDrafts = await this.generateQuestionsWithAnswers(
      passage,
      questionCount,
      env
    );
    
    console.log('ğŸ­ Step 3: Generating distractors (parallel)...');
    const questions = await Promise.all(
      questionDrafts.map(async (draft, index) => {
        const distractors = await this.generateDistractors(passage, draft, env);
        
        // æ­£è§£ã¨èª¤ç­”ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        const allChoices = [draft.correct_answer_text, ...distractors];
        const shuffled = this.shuffle(allChoices);
        const correctIndex = shuffled.indexOf(draft.correct_answer_text);
        
        return {
          questionNumber: index + 1,
          questionText: draft.question_text,
          choices: shuffled,
          correctAnswerIndex: correctIndex,
          explanation: `æ ¹æ‹ : ${draft.evidence_quote}`,
          explanationJa: `ã“ã®å•é¡Œã®ç­”ãˆã¯ã€æœ¬æ–‡ã®ã€Œ${draft.evidence_quote}ã€ã¨ã„ã†è¨˜è¿°ã‹ã‚‰å°ã‹ã‚Œã¾ã™ã€‚`,
          evidenceQuote: draft.evidence_quote,
          questionType: draft.question_type
        };
      })
    );
    
    return {
      passage,
      wordCount: passage.split(/\s+/).length,
      questions,
      passageType: 'expository',
      topic,
      difficulty: 0.5
    };
  }
  
  private static shuffle<T>(array: T[]): T[] {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
  }
  
  private static getWordCount(grade: EikenGrade): number {
    const counts: Record<string, number> = {
      '5': 60,
      '4': 100,
      '3': 150,
      'pre2': 220,
      '2': 300,
      'pre1': 400,
      '1': 550
    };
    return counts[grade] || 300;
  }
}

interface QuestionDraft {
  question_number: number;
  question_text: string;
  evidence_quote: string;
  correct_answer_text: string;
  question_type: string;
}
```

### ã‚³ã‚¹ãƒˆè©¦ç®—

```typescript
const READING_COMP_COST_ESTIMATE = {
  step1_passage: {
    model: 'gpt-4o',
    inputTokens: 500,
    outputTokens: 400,  // 300èªãƒ‘ãƒƒã‚»ãƒ¼ã‚¸
    costUSD: (500 * 2.50 + 400 * 10.00) / 1_000_000  // $0.005
  },
  step2_questions: {
    model: 'gpt-4o',
    inputTokens: 900,  // ãƒ‘ãƒƒã‚»ãƒ¼ã‚¸ + ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    outputTokens: 400,  // 3å•ã®è³ªå•+æ­£ç­”
    costUSD: (900 * 2.50 + 400 * 10.00) / 1_000_000  // $0.006
  },
  step3_distractors: {
    model: 'gpt-4o',
    calls: 3,  // å„è³ªå•ã”ã¨
    inputTokensPerCall: 1000,
    outputTokensPerCall: 150,
    costUSD: 3 * ((1000 * 2.50 + 150 * 10.00) / 1_000_000)  // $0.012
  },
  total: 0.023  // ç´„$0.023/ã‚»ãƒƒãƒˆ
};

// 100ã‚»ãƒƒãƒˆç”Ÿæˆ: $2.30
// 1000ã‚»ãƒƒãƒˆç”Ÿæˆ: $23.00
// â†’ è¨±å®¹ç¯„å›²å†…ã€å“è³ªå‘ä¸Šã®ãƒ¡ãƒªãƒƒãƒˆãŒå¤§ãã„
```

### å®Ÿè£…ã‚¿ã‚¹ã‚¯

```typescript
const PHASE5_TASKS = [
  {
    id: 'P5-1',
    task: 'Passages ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ',
    file: 'migrations/0013_create_passages_table.sql',
    priority: 'HIGH',
    estimatedHours: 2
  },
  {
    id: 'P5-2',
    task: 'Chain of Generationå®Ÿè£…ï¼ˆ3æ®µéšï¼‰',
    file: 'src/eiken/services/reading-comprehension-generator.ts',
    priority: 'CRITICAL',
    estimatedHours: 10
  },
  {
    id: 'P5-3',
    task: 'ä¸€è²«æ€§æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯',
    file: 'src/eiken/services/reading-validator.ts',
    priority: 'HIGH',
    estimatedHours: 4,
    notes: 'ä»£åè©è§£æ¶ˆãƒã‚§ãƒƒã‚¯ã€æ™‚åˆ¶ä¸€è²«æ€§æ¤œè¨¼'
  },
  {
    id: 'P5-4',
    task: 'ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆå“è³ªæ¤œè¨¼ï¼‰',
    file: 'tests/reading-comprehension.test.ts',
    priority: 'HIGH',
    estimatedHours: 5
  },
  {
    id: 'P5-5',
    task: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ',
    file: 'tests/reading-performance.test.ts',
    priority: 'MEDIUM',
    estimatedHours: 3,
    notes: 'APIå‘¼ã³å‡ºã—æ™‚é–“ã€ä¸¦åˆ—åŒ–åŠ¹æœæ¸¬å®š'
  }
];

// åˆè¨ˆè¦‹ç©: 24æ™‚é–“ï¼ˆç´„3å–¶æ¥­æ—¥ï¼‰
```

---

## ğŸ› ï¸ å…±é€šæ”¹å–„ã‚¿ã‚¹ã‚¯

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ“ãƒ«ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 

**æ¡ç”¨æ–¹é‡**: Geminiææ¡ˆã®ã€ŒPrompt Builder ãƒ‘ã‚¿ãƒ¼ãƒ³ã€

```typescript
// æ–°ãƒ•ã‚¡ã‚¤ãƒ«: src/eiken/services/prompt-builder.ts

export class PromptBuilder {
  
  private baseSystem: string;
  private constraints: string[] = [];
  private instructions: string[] = [];
  private examples: string[] = [];
  
  constructor(questionType: QuestionType) {
    this.baseSystem = BASE_SYSTEM_PROMPTS[questionType];
  }
  
  addConstraint(constraint: string): this {
    this.constraints.push(constraint);
    return this;
  }
  
  addGradeConstraints(grade: EikenGrade): this {
    const gradeInfo = GRADE_CONSTRAINTS[grade];
    this.constraints.push(`CEFR Level: ${gradeInfo.cefrLevel}`);
    this.constraints.push(`Vocabulary: ${gradeInfo.vocabRange.min}-${gradeInfo.vocabRange.max} words`);
    this.constraints.push(`Grammar Focus: ${gradeInfo.grammarPoints.join(', ')}`);
    return this;
  }
  
  addTopicConstraints(topic: TopicArea): this {
    this.constraints.push(`Topic: ${topic.label}`);
    return this;
  }
  
  addInstruction(instruction: string): this {
    this.instructions.push(instruction);
    return this;
  }
  
  addExample(example: string): this {
    this.examples.push(example);
    return this;
  }
  
  build(): { system: string; user: string } {
    const systemPrompt = `
${this.baseSystem}

# Constraints
${this.constraints.map((c, i) => `${i + 1}. ${c}`).join('\n')}

${this.instructions.length > 0 ? `# Instructions\n${this.instructions.join('\n')}` : ''}

${this.examples.length > 0 ? `# Examples\n${this.examples.join('\n\n')}` : ''}
    `.trim();
    
    return {
      system: systemPrompt,
      user: this.buildUserPrompt()
    };
  }
  
  private buildUserPrompt(): string {
    return 'Generate the question according to the specifications above.';
  }
}

// ä½¿ç”¨ä¾‹
const prompt = new PromptBuilder('gap-fill')
  .addGradeConstraints('2')
  .addTopicConstraints(selectRandomTopic('2'))
  .addConstraint('Focus on passive voice')
  .addInstruction('Ensure all choices are grammatically valid')
  .build();
```

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†

```sql
-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE IF NOT EXISTS eiken_prompt_templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    template_version TEXT NOT NULL UNIQUE,  -- 'v1.0.0', 'v1.1.0'
    question_type TEXT NOT NULL,
    template_text TEXT NOT NULL,
    is_active INTEGER DEFAULT 0,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    activated_at TEXT,
    performance_metrics TEXT,  -- JSON: æ¡ç”¨ç‡ã€å“è³ªã‚¹ã‚³ã‚¢ç­‰
    CHECK (is_active IN (0, 1)),
    CHECK (json_valid(performance_metrics) OR performance_metrics IS NULL)
);

CREATE INDEX idx_prompt_templates_active 
    ON eiken_prompt_templates(question_type, is_active);
```

---

## ğŸ“Š ç·åˆå®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

| Phase | å†…å®¹ | è¦‹ç©å·¥æ•° | å„ªå…ˆåº¦ | é–‹å§‹æ¡ä»¶ |
|---|---|---|---|---|
| **Phase 1** | èªå½™ãƒ¬ãƒ™ãƒ«ç®¡ç† | 23æ™‚é–“ï¼ˆ3æ—¥ï¼‰ | ğŸ”¥ CRITICAL | ãªã— |
| **Phase 2** | ãƒˆãƒ”ãƒƒã‚¯åˆ†é‡ç®¡ç† | 10æ™‚é–“ï¼ˆ1.5æ—¥ï¼‰ | âš ï¸ HIGH | Phase 1å®Œäº†å¾Œ |
| **Phase 3** | å•é¡Œå½¢å¼å¤šæ§˜åŒ– | 14æ™‚é–“ï¼ˆ2æ—¥ï¼‰ | âš ï¸ HIGH | Phase 2å®Œäº†å¾Œ |
| **Phase 4** | 2024å¹´åº¦å¯¾å¿œ | 30æ™‚é–“ï¼ˆ4æ—¥ï¼‰ | âš ï¸ HIGH | Phase 3å®Œäº†å¾Œ |
| **Phase 5** | é•·æ–‡èª­è§£ | 24æ™‚é–“ï¼ˆ3æ—¥ï¼‰ | ğŸ“Œ MEDIUM | Phase 4å®Œäº†å¾Œ |
| **å…±é€šæ”¹å–„** | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ“ãƒ«ãƒ€ãƒ¼ | 8æ™‚é–“ï¼ˆ1æ—¥ï¼‰ | ğŸ“Œ MEDIUM | Phase 1ã¨ä¸¦è¡Œå¯ |

**åˆè¨ˆè¦‹ç©**: 109æ™‚é–“ï¼ˆç´„14å–¶æ¥­æ—¥ï¼‰

### ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹

```
Phase 1 (èªå½™ç®¡ç†) [3æ—¥]
  â†“
Phase 2 (ãƒˆãƒ”ãƒƒã‚¯) [1.5æ—¥]
  â†“
Phase 3 (ä¼šè©±ãƒ»æ•´åº) [2æ—¥]
  â†“
Phase 4 (ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°) [4æ—¥]
  â†“
Phase 5 (é•·æ–‡èª­è§£) [3æ—¥]
  â†“
çµ±åˆãƒ†ã‚¹ãƒˆãƒ»èª¿æ•´ [2æ—¥]
  â†“
æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
```

---

## ğŸ¯ å®Ÿè£…ã®åˆ¤æ–­åŸºæº–

### ã™ã¹ã¦æŠ€è¡“çš„ã«å®Ÿç¾å¯èƒ½ âœ…

| æ©Ÿèƒ½ | å®Ÿç¾å¯èƒ½æ€§ | æ¨å¥¨å®Ÿè£… | æ³¨æ„ç‚¹ |
|---|---|---|---|
| èªå½™ç®¡ç† | âœ… 100% | CEFR-J + SVLçµ±åˆ + Lemmatization | compromiseä½¿ç”¨ï¼ˆWorkersäº’æ›ï¼‰ |
| Chain of Generation | âœ… 100% | 3ã‚¹ãƒ†ãƒƒãƒ—ç”Ÿæˆ | ã‚³ã‚¹ãƒˆå¢—ï¼ˆ$0.023/ã‚»ãƒƒãƒˆï¼‰ã¯è¨±å®¹ç¯„å›² |
| è‡ªå‹•æ¡ç‚¹ | âœ… 95% | AIæ¡ç‚¹ + äººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½µç”¨ | 80%ä¸€è‡´ç‡é”æˆå¯èƒ½ |
| JSON Payload | âš ï¸ 70% | ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¨å¥¨ | å®Œå…¨JSONåŒ–ã¯é¿ã‘ã‚‹ |

---

## ğŸ”§ æŠ€è¡“çš„æ¨å¥¨äº‹é …

### æ¡ç”¨ã™ã¹ãã‚¢ã‚¤ãƒ‡ã‚¢ âœ…

1. âœ… **CEFR-J + SVL 12000ã®çµ±åˆ**ï¼ˆClaudeææ¡ˆï¼‰
2. âœ… **Lemmatization with compromise**ï¼ˆClaudeææ¡ˆã€Workerså¯¾å¿œï¼‰
3. âœ… **Chain of Generation**ï¼ˆGemini/ChatGPT/Gensparkã€å“è³ªé‡è¦–ï¼‰
4. âœ… **3%é–¾å€¤ã§ã®èªå½™æ¤œè¨¼**ï¼ˆGeminiææ¡ˆï¼‰
5. âœ… **PromptBuilder ãƒ‘ã‚¿ãƒ¼ãƒ³**ï¼ˆå…¨AIä¸€è‡´ï¼‰
6. âœ… **ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯æ˜ç¤ºå‹æ¡ç‚¹**ï¼ˆå…¨AIä¸€è‡´ï¼‰
7. âœ… **æ­£è¦åŒ–ã‚¹ã‚­ãƒ¼ãƒ + metadataæ‹¡å¼µ**ï¼ˆæ—¢å­˜æ–¹é‡ + æŸ”è»Ÿæ€§ï¼‰

### é¿ã‘ã‚‹ã¹ãã‚¢ã‚¤ãƒ‡ã‚¢ âŒ

1. âŒ **å®Œå…¨JSON Payloadæ–¹å¼**ï¼ˆæ¤œç´¢æ€§ãƒ»å‹å®‰å…¨æ€§ãŒçŠ ç‰²ï¼‰
2. âŒ **1å›ã®APIå‘¼ã³å‡ºã—ã§é•·æ–‡+è¨­å•**ï¼ˆå“è³ªãŒä½ä¸‹ï¼‰

---

## ğŸ“š æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### å³åº§ã«é–‹å§‹ã§ãã‚‹ã‚¿ã‚¹ã‚¯

```bash
# 1. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install compromise

# 2. èªå½™è¾æ›¸ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
# - CEFR-J ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®ç¢ºèª
# - SVL 12000 ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç¢ºèª
# - NGSL/NAWL ãƒ‡ãƒ¼ã‚¿å–å¾—

# 3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æº–å‚™
# - migrations/0009_create_vocabulary_lexicon.sql ä½œæˆ

# 4. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™
# - å„ç´šã®ã‚µãƒ³ãƒ—ãƒ«å•é¡Œï¼ˆäººé–“è©•ä¾¡ç”¨ï¼‰
# - æ¡ç‚¹ç²¾åº¦æ¤œè¨¼ç”¨ã®ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ³ãƒ—ãƒ«
```

### è³ªå•ãƒ»ç›¸è«‡äº‹é …

1. **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ©ã‚¤ã‚»ãƒ³ã‚¹**: CEFR-Jã€SVL 12000ã®åˆ©ç”¨æ¡ä»¶ç¢ºèªãŒå¿…è¦
2. **Phaseå„ªå…ˆé †ä½**: ææ¡ˆã—ãŸé †åºã§å•é¡Œãªã„ã‹ï¼Ÿåˆ¥ã®é †åºã‚’å¸Œæœ›ã™ã‚‹ã‹ï¼Ÿ
3. **ã‚³ã‚¹ãƒˆæ‰¿èª**: Chain of Generation ã®ã‚³ã‚¹ãƒˆå¢—ï¼ˆ$0.023/ã‚»ãƒƒãƒˆï¼‰ã¯è¨±å®¹ç¯„å›²ã‹ï¼Ÿ
4. **å“è³ªåŸºæº–**: è‡ªå‹•æ¡ç‚¹ã®ç›®æ¨™ä¸€è‡´ç‡80%ã§è‰¯ã„ã‹ï¼Ÿã‚ˆã‚Šé«˜ã„ç²¾åº¦ãŒå¿…è¦ã‹ï¼Ÿ

---

**ã“ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã«ã¤ã„ã¦ã€ã”æ„è¦‹ãƒ»ã”æŒ‡ç¤ºã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ï¼** ğŸš€
