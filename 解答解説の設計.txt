1. システムのゴール（全体像）
今回お願いしたいのは、

「生徒が、実際に学校の先生から教わっているように感じる」解説を、自動生成できるレイヤーを、既存の英検AIシステムの上に追加する

というものです。
ポイントは：


すでにある


文法問題生成


解説生成


品質チェック（複数正解チェックなどを導入予定）




に対して、


「日本の学校英語の文法用語と鉄則（パターン）」をきちんと使った“学校の先生スタイル”の解説生成レイヤーを追加する、という「拡張」です。
既存のロジックを全て捨てるのではなく、


① これまでの解説生成ロジック


② 学年別英語表現データ（JSON / テキストで渡しているもの）


③ 新しい「教師風テンプレ＋鉄則構造」


を組み合わせて、一段賢い解説エンジンにするイメージです。

2. 解説システムのコンセプト（重要な考え方）
このレイヤーの設計思想はシンプルで、

“意味の説明”ではなく、“学校で習う文法ルールに基づく説明”をさせる

というものです。
例えば、今のAIの解説が：

未来を表す文なので will を使います。if の後には動詞の原形が必要ですが……

となっているところを、

＜鉄則！＞ if節では未来のことでも現在形を使う
→ 主語が it（3単現）なので、rains を使います。
rain は動詞の原形、rained は過去形、is raining は現在進行形なので、この文には合いません。

のように、「日本の中学・高校で使う言葉」「黒板で説明する論理」に寄せたい、という狙いです。

3. 実装してほしい“6つの要素”
3-1. 文法タグの検出レイヤー
目的：問題ごとに「どの文法ポイントの問題か」をラベル付けしておく。
例：


if + tomorrow → ["conditional_clause", "present_for_future", "third_person_singular"]


She _____ tennis every Sunday. → ["present_simple_habit", "third_person_singular"]


have + 過去分詞 → ["present_perfect"]


enjoy + V-ing → ["verb_taking_gerund"]


実装イメージ：


簡易なルールベース + 必要なら軽いLLM補助


文法ポイントごとにタグを定義しておく
例：conditional_clause, third_person_singular, present_perfect, passive_voice, etc.


このタグは後続の「鉄則選択」「解説テンプレ選択」に使います。

3-2. 「学年別英語表現データ」のインポートと参照
ユーザー側から渡している

学年別英語表現一覧（学校で習うフレーズ＋パターン＋日本語の説明）

を、Cloudflare D1 か、少なくともアプリ側で JSON として扱えるようにしてください。
推奨スキーマ（例）
CREATE TABLE grammar_rules (
  id TEXT PRIMARY KEY,            -- 例: "H3-019"
  pattern TEXT NOT NULL,          -- 例: "if + 現在形"
  rule_jp TEXT NOT NULL,          -- 例: "時・条件の副詞節では未来でも現在形"
  tags TEXT NOT NULL,             -- JSON: ["conditional_clause", "present_for_future"]
  grade TEXT NOT NULL             -- 例: "中3"
);

CREATE TABLE grammar_terms (
  term_key TEXT PRIMARY KEY,      -- 例: "third_person_singular"
  term_jp TEXT NOT NULL,          -- 例: "3単現のs"
  explanation_jp TEXT NOT NULL    -- 例: "主語がhe / she / it のとき動詞にs"
);

ここで重要なのは、


「if節では未来でも現在形」


「主語が he / she / it のとき 3単現のs」


「不定詞は to + 動詞の原形」


「受動態は be動詞 + 過去分詞」


のような “鉄則レベルの文法ルール” を、
「タグ付きで取れる」ようにしておくことです。

3-3. 学校の先生風「解説テンプレート」を導入
解説はすべて、次の 4ブロック構成にしてください：


＜着眼点＞


if がある


tomorrow がある


every Sunday がある


ago / since / for などがある
→ 生徒に「まずここを見てね」というガイド




＜鉄則！ or Point！＞


grammar_rules テーブルの rule_jp をここで使う


例：「時・条件の副詞節では未来でも現在形」




＜この問題への当てはめ＞


主語が it → 3単現の s


だから rains


if節なので will は使わない




＜誤答の理由（1行ずつ）＞


rain：原形。3単現のsがついていないので ×


rained：過去形。if節では現在形を使うので ×


is raining：進行形。条件節では使わないので ×




生成イメージ
＜着眼点＞
if（もし〜なら）と tomorrow（明日）があるので、「未来の条件」の文です。

＜鉄則！＞
時・条件の副詞節（if / when など）では、未来のことでも現在形を使います。（H3-019）

＜当てはめ＞
if の中は現在形にするので、動詞の形は現在形です。
主語が it（3単現）なので、3単現のsをつけて rains になります。

＜誤答の理由＞
rain：動詞の原形。3単現のsがついていないので ×  
rained：過去形。if節では現在形を使うので ×  
is raining：現在進行形。条件節では基本的に使わないので ×  

▶ 正解：rains

この形式を「テンプレート」として固定しておくと、LLMにとっても再現しやすくなります。

3-4. プロンプト設計（解説生成用）
解説を生成する LLM 呼び出しでは、system メッセージを明確にします。
System メッセージ（ざっくり構成）


あなたは日本の中学・高校の英語教師


日本の学校で使う文法用語を使うこと


3単現のs / 動詞の原形 / 過去形 / 過去分詞 / 現在完了 / 不定詞 / 動名詞 / 受動態 など




与えられた grammar_rules / grammar_terms を必ず参照すること


解説は次の4ブロックで出力：


＜着眼点＞


＜鉄則！＞


＜当てはめ＞


＜誤答の理由＞




User メッセージの情報


問題文


選択肢


正解・誤答


検出された文法タグ一覧（Layer 1 の結果）


grammar_rules / grammar_terms のうち関連しそうなもの（タグで絞り込んで渡す）


LLMには「すでに渡されている文法ルール／用語だけを使って解説する」よう指示してください。

3-5. 会話形式問題との統合（Gemini案）
すでに相談している


会話形式（A/B形式）で問題を生成する（文脈を持たせる）


AIによる複数正解チェックで曖昧な問題を弾く


は、そのまま問題生成側のレイヤーとして進行してもらってOKです。
解説生成は 「完成済みの問題＋正解」 を入力として使うので、


文脈あり問題


単文問題
のどちらにも対応できます。


※ 会話形式の場合は、＜着眼点＞の中で


Aさんのセリフに注目


Bさんが「〜してくれる？」と頼んでいる


のような「文脈の見どころ」を出せるとベストです（これは後で微調整でもOK）。

3-6. NGワード・品質チェック
最後に、生成された解説の後処理として、簡単な文字列チェックを入れてください。
NG 例（避けたい解説の言い方）


「未来を表す文なので will を使います」（→ルールがざっくりしすぎ）


「if の後には動詞の原形を使います」（→誤情報）


「なんとなく〜のニュアンスです」（→感覚的すぎて中学生向きではない）


→ これらのフレーズが含まれていた場合は、「再生成」か「ログにフラグ」を付ける運用にできると安心です。
逆に、


「if節では〜」


「3単現のs」


「動詞の原形」


「過去形」「現在進行形」「現在完了形」


などの学校文法用語がちゃんと含まれているかをチェック指標にしても良いと思います。

4. 実装の流れ（優先度つき）
「どこから手を付ければ迷わないか」のために、ステップ順に整理します。
Step 1：文法タグ検出の仕組みを作る


正規表現 + 簡単なルールベースでOK（必要なら LLM 併用でも可）


各問題に grammar_tags: string[] を付与
→ 例：["conditional_clause", "third_person_singular"]


Step 2：「学年別英語表現データ」をDB or JSONとして構造化


D1 に入れるか、ビルド時に JSON を読み込む形でも可


grammar_rules / grammar_terms のような形で扱えるようにする


Step 3：解説テンプレート & プロンプトを実装


system メッセージで「教師役」＆「4ブロック構成」を強制


user メッセージで：問題＋選択肢＋タグ＋ルールデータを渡す


Step 4：既存の解説生成処理と差し替え or ラップ


今までの「解説生成関数」を、この新レイヤー経由にする


うまくいかない場合のフォールバックも一応用意（旧式解説など）


Step 5：簡易の品質チェック


NG フレーズ検出


必須語（3単現のs / 現在形 / 過去形 等）の使用率チェック（余裕があれば）



5. 最後に（AIデベロッパーの方へ）


これは「ゼロから別システムを作る」というより、
すでにある 問題生成＆解説生成フローの“解説部分”に、日本の学校英語の頭脳を差し込む改修です。


技術的には：


文法タグ付け


ルール参照（RAG的）


プロンプトの構造化


簡単なポストプロセス




を組み合わせるだけなので、既存コードベースと問題なく統合できるはずです。


もし、


D1 のスキーマ


実際の TypeScript/Cloudflare Workers 側の関数設計


LLM プロンプトの具体的なテキスト


など、さらに細かいレベルの実装案が必要であれば、そこもこちらで具体的なひな型を用意できます。遠慮なく言ってください。
