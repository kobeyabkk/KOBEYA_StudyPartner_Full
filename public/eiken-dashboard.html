<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EIKEN ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }

    h1 {
      font-size: 28px;
      color: #1a202c;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #718096;
      font-size: 14px;
    }

    .filters {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }

    select, button {
      padding: 10px 16px;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      background: white;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    select:hover, button:hover {
      border-color: #4299e1;
    }

    button {
      background: #4299e1;
      color: white;
      border: none;
      font-weight: 600;
    }

    button:hover {
      background: #3182ce;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .metric-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }

    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .metric-label {
      font-size: 14px;
      color: #718096;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .metric-value {
      font-size: 36px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 4px;
    }

    .metric-change {
      font-size: 12px;
      color: #48bb78;
    }

    .metric-change.negative {
      color: #f56565;
    }

    .chart-container {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #1a202c;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    th {
      background: #f7fafc;
      font-weight: 600;
      color: #4a5568;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    td {
      color: #2d3748;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: #c6f6d5;
      color: #22543d;
    }

    .badge-warning {
      background: #feebc8;
      color: #7c2d12;
    }

    .badge-danger {
      background: #fed7d7;
      color: #742a2a;
    }

    .alert {
      background: #fff5f5;
      border-left: 4px solid #f56565;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .alert-title {
      font-weight: 600;
      color: #742a2a;
      margin-bottom: 4px;
    }

    .alert-message {
      color: #822727;
      font-size: 14px;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
    }

    .spinner {
      border: 3px solid #e2e8f0;
      border-top: 3px solid #4299e1;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fff5f5;
      color: #742a2a;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #fc8181;
    }

    .last-updated {
      color: #a0aec0;
      font-size: 12px;
      text-align: right;
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ“Š EIKEN ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <p class="subtitle">Phase 7.8.1 - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å“è³ªç›£è¦–</p>
    </header>

    <div class="filters">
      <select id="gradeFilter">
        <option value="">å…¨ã¦ã®ã‚°ãƒ¬ãƒ¼ãƒ‰</option>
        <option value="5">Grade 5</option>
        <option value="4">Grade 4</option>
        <option value="3">Grade 3</option>
        <option value="pre-2">Grade Pre-2</option>
        <option value="2">Grade 2</option>
        <option value="pre-1">Grade Pre-1</option>
        <option value="1">Grade 1</option>
      </select>

      <select id="formatFilter">
        <option value="">å…¨ã¦ã®å½¢å¼</option>
        <option value="grammar_fill">Grammar Fill</option>
        <option value="long_reading">Long Reading</option>
        <option value="essay">Essay</option>
        <option value="opinion_speech">Opinion Speech</option>
      </select>

      <button id="refreshBtn">ğŸ”„ æ›´æ–°</button>
      <button id="autoRefreshBtn">â±ï¸ è‡ªå‹•æ›´æ–°: OFF</button>
    </div>

    <div id="alerts-container"></div>

    <div class="metrics-grid" id="metrics-grid">
      <div class="loading">
        <div class="spinner"></div>
        <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
    </div>

    <div class="chart-container">
      <h2 class="chart-title">ğŸ“ˆ ã‚°ãƒ¬ãƒ¼ãƒ‰åˆ¥çµ±è¨ˆ</h2>
      <div id="grade-stats-table"></div>
    </div>

    <div class="chart-container">
      <h2 class="chart-title">ğŸ“‹ å½¢å¼åˆ¥çµ±è¨ˆ</h2>
      <div id="format-stats-table"></div>
    </div>

    <div class="chart-container">
      <h2 class="chart-title">ğŸ§ª A/B ãƒ†ã‚¹ãƒˆçµæœ</h2>
      <div id="experiments-table"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://kobeyabkk-studypartner.pages.dev/api/eiken/monitoring';
    let autoRefreshInterval = null;

    async function loadMetrics() {
      try {
        const grade = document.getElementById('gradeFilter').value;
        const format = document.getElementById('formatFilter').value;
        
        const params = new URLSearchParams();
        if (grade) params.append('grade', grade);
        if (format) params.append('format', format);

        const url = `${API_BASE}/stats?${params.toString()}`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
          displayMetrics(data.data.overall);
          displayGradeStats(data.data.byGrade);
          displayFormatStats(data.data.byFormat);
        } else {
          showError('ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('Error loading metrics:', error);
        showError(error.message);
      }
    }

    async function loadAlerts() {
      try {
        const response = await fetch(`${API_BASE}/alerts`);
        const data = await response.json();

        if (data.success && data.data.length > 0) {
          displayAlerts(data.data);
        }
      } catch (error) {
        console.error('Error loading alerts:', error);
      }
    }

    async function loadExperiments() {
      try {
        const response = await fetch(`${API_BASE}/experiments`);
        const data = await response.json();

        if (data.success) {
          displayExperiments(data.data);
        }
      } catch (error) {
        console.error('Error loading experiments:', error);
      }
    }

    function displayMetrics(metrics) {
      const grid = document.getElementById('metrics-grid');
      
      if (!metrics) {
        grid.innerHTML = '<div class="loading"><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }

      grid.innerHTML = `
        <div class="metric-card">
          <div class="metric-label">ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°</div>
          <div class="metric-value">${metrics.total_requests || 0}</div>
          <div class="metric-change">éå»24æ™‚é–“</div>
        </div>

        <div class="metric-card">
          <div class="metric-label">æˆåŠŸç‡</div>
          <div class="metric-value">${metrics.success_rate_pct || 0}%</div>
          <div class="metric-change ${metrics.success_rate_pct >= 90 ? '' : 'negative'}">
            ç›®æ¨™: 90%
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-label">æ¤œè¨¼æˆåŠŸç‡</div>
          <div class="metric-value">${metrics.validation_rate_pct || 0}%</div>
          <div class="metric-change ${metrics.validation_rate_pct >= 90 ? '' : 'negative'}">
            ç›®æ¨™: 90%
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-label">å¹³å‡ç”Ÿæˆæ™‚é–“</div>
          <div class="metric-value">${(metrics.avg_generation_time_ms / 1000).toFixed(2)}s</div>
          <div class="metric-change ${metrics.avg_generation_time_ms < 5000 ? '' : 'negative'}">
            ${metrics.avg_generation_time_ms}ms
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-label">èªå½™ã‚¹ã‚³ã‚¢</div>
          <div class="metric-value">${metrics.avg_vocab_score || 0}</div>
          <div class="metric-change">å¹³å‡</div>
        </div>

        <div class="metric-card">
          <div class="metric-label">è‘—ä½œæ¨©ã‚¹ã‚³ã‚¢</div>
          <div class="metric-value">${metrics.avg_copyright_score || 0}</div>
          <div class="metric-change">å¹³å‡</div>
        </div>

        <div class="metric-card">
          <div class="metric-label">ãƒˆãƒ”ãƒƒã‚¯å¤šæ§˜æ€§</div>
          <div class="metric-value">${metrics.avg_topic_diversity || 0}</div>
          <div class="metric-change">Phase 7.7</div>
        </div>

        <div class="metric-card">
          <div class="metric-label">å‹•è©å¤šæ§˜æ€§</div>
          <div class="metric-value">${metrics.avg_verb_diversity || 0}</div>
          <div class="metric-change">Phase 7.7</div>
        </div>
      `;

      document.querySelector('.last-updated')?.remove();
      grid.insertAdjacentHTML('afterend', `
        <div class="last-updated">
          æœ€çµ‚æ›´æ–°: ${new Date().toLocaleString('ja-JP')}
        </div>
      `);
    }

    function displayGradeStats(stats) {
      const container = document.getElementById('grade-stats-table');
      
      if (!stats || stats.length === 0) {
        container.innerHTML = '<p style="color: #a0aec0;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Grade</th>
              <th>ç·æ•°</th>
              <th>æˆåŠŸç‡</th>
              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            </tr>
          </thead>
          <tbody>
            ${stats.map(stat => `
              <tr>
                <td><strong>Grade ${stat.grade}</strong></td>
                <td>${stat.total}</td>
                <td>${stat.success_rate_pct}%</td>
                <td>
                  <span class="badge ${stat.success_rate_pct >= 90 ? 'badge-success' : stat.success_rate_pct >= 70 ? 'badge-warning' : 'badge-danger'}">
                    ${stat.success_rate_pct >= 90 ? 'âœ… Good' : stat.success_rate_pct >= 70 ? 'âš ï¸ Warning' : 'âŒ Poor'}
                  </span>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function displayFormatStats(stats) {
      const container = document.getElementById('format-stats-table');
      
      if (!stats || stats.length === 0) {
        container.innerHTML = '<p style="color: #a0aec0;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>å½¢å¼</th>
              <th>ç·æ•°</th>
              <th>æˆåŠŸç‡</th>
              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            </tr>
          </thead>
          <tbody>
            ${stats.map(stat => `
              <tr>
                <td><strong>${stat.format}</strong></td>
                <td>${stat.total}</td>
                <td>${stat.success_rate_pct}%</td>
                <td>
                  <span class="badge ${stat.success_rate_pct >= 90 ? 'badge-success' : stat.success_rate_pct >= 70 ? 'badge-warning' : 'badge-danger'}">
                    ${stat.success_rate_pct >= 90 ? 'âœ… Good' : stat.success_rate_pct >= 70 ? 'âš ï¸ Warning' : 'âŒ Poor'}
                  </span>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function displayAlerts(alerts) {
      const container = document.getElementById('alerts-container');
      
      container.innerHTML = alerts.map(alert => `
        <div class="alert">
          <div class="alert-title">ğŸš¨ ${alert.alertName}</div>
          <div class="alert-message">
            å€¤: ${alert.metricValue.toFixed(2)} (é–¾å€¤: ${alert.thresholdValue})
            ${alert.grade ? ` - Grade ${alert.grade}` : ''}
            ${alert.format ? ` - ${alert.format}` : ''}
          </div>
        </div>
      `).join('');
    }

    function displayExperiments(experiments) {
      const container = document.getElementById('experiments-table');
      
      if (!experiments || experiments.length === 0) {
        container.innerHTML = '<p style="color: #a0aec0;">å®Ÿè¡Œä¸­ã®A/Bãƒ†ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      // Group by experiment
      const grouped = experiments.reduce((acc, exp) => {
        if (!acc[exp.experiment_id]) {
          acc[exp.experiment_id] = {
            name: exp.experiment_name,
            variants: []
          };
        }
        acc[exp.experiment_id].variants.push(exp);
        return acc;
      }, {});

      container.innerHTML = Object.entries(grouped).map(([id, data]) => `
        <div style="margin-bottom: 24px;">
          <h3 style="margin-bottom: 12px;">${data.name}</h3>
          <table>
            <thead>
              <tr>
                <th>Variant</th>
                <th>ã‚µãƒ³ãƒ—ãƒ«æ•°</th>
                <th>æˆåŠŸç‡</th>
                <th>æ¤œè¨¼ç‡</th>
                <th>ç”Ÿæˆæ™‚é–“</th>
              </tr>
            </thead>
            <tbody>
              ${data.variants.map(v => `
                <tr>
                  <td><strong>${v.variant}</strong></td>
                  <td>${v.sample_size}</td>
                  <td>${v.success_rate_pct}%</td>
                  <td>${v.validation_rate_pct}%</td>
                  <td>${v.avg_gen_time_ms}ms</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `).join('');
    }

    function showError(message) {
      document.getElementById('metrics-grid').innerHTML = `
        <div class="error">
          <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${message}
        </div>
      `;
    }

    function toggleAutoRefresh() {
      const btn = document.getElementById('autoRefreshBtn');
      
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        btn.textContent = 'â±ï¸ è‡ªå‹•æ›´æ–°: OFF';
        btn.style.background = '#4299e1';
      } else {
        autoRefreshInterval = setInterval(loadAll, 30000); // 30 seconds
        btn.textContent = 'â±ï¸ è‡ªå‹•æ›´æ–°: ON (30s)';
        btn.style.background = '#48bb78';
      }
    }

    function loadAll() {
      loadMetrics();
      loadAlerts();
      loadExperiments();
    }

    // Event listeners
    document.getElementById('refreshBtn').addEventListener('click', loadAll);
    document.getElementById('autoRefreshBtn').addEventListener('click', toggleAutoRefresh);
    document.getElementById('gradeFilter').addEventListener('change', loadMetrics);
    document.getElementById('formatFilter').addEventListener('change', loadMetrics);

    // Initial load
    loadAll();
  </script>
</body>
</html>
