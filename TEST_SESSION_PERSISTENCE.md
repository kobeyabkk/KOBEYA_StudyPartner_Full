# 📝 セッション永続化テスト手順（初心者向け）

## 🎯 このテストの目的
Cloudflare Workerが再起動しても、セッションデータ（アップロードした画像・OCR結果・添削フィードバック）が失われないことを確認します。

---

## 🧪 テスト手順

### ステップ1: アプリケーションにアクセス
1. ブラウザで以下のURLを開く：
   ```
   https://kobeyabkk-studypartner.pages.dev
   ```

2. **小論文添削コーチ** セクションに移動

3. **「セッション初期化」** ボタンをクリック

4. **重要**: ブラウザのアドレスバーに表示されるURLをコピーして保存
   ```
   例: https://kobeyabkk-studypartner.pages.dev/?session=abc123def456
   ```
   この `?session=abc123def456` の部分がセッションIDです

---

### ステップ2: 画像をアップロード
1. **「画像をアップロード」** ボタンをクリック

2. 手書きの小論文画像を1〜2枚選択してアップロード

3. アップロードが完了すると、画像のプレビューが表示されます

4. **確認ポイント**:
   - ✅ 画像が表示されている
   - ✅ ファイル名が表示されている

---

### ステップ3: OCR処理を実行
1. **「OCR処理を実行」** ボタンをクリック

2. 処理完了を待つ（10〜30秒程度）

3. **確認ポイント**:
   - ✅ OCRテキストが表示される
   - ✅ 「OCR結果を修正」ボタンが表示される

4. **テスト用メモ**: 
   - OCRテキストの最初の1行をメモ帳にコピーしておく
   - 例: 「私は将来、医師になりたいと考えている。」

---

### ステップ4: セッションIDを確認
1. ブラウザのアドレスバーに表示されているURLを確認

2. `?session=` の後ろの文字列（セッションID）をコピー

3. メモ帳に保存
   ```
   セッションID: abc123def456
   ```

---

### ステップ5: 別のタブでD1データベースを確認
1. Cloudflare Dashboard → D1 → `kobeya-logs-db` を開く

2. **Console** タブをクリック

3. 以下のSQLクエリを実行:
   ```sql
   SELECT session_id, uploaded_images_count, has_ocr_results, updated_at 
   FROM essay_sessions 
   ORDER BY updated_at DESC 
   LIMIT 5;
   ```

4. **確認ポイント**:
   - ✅ 自分のセッションIDが表示される
   - ✅ `uploaded_images_count` が 1 以上
   - ✅ `has_ocr_results` が 1 (true)
   - ✅ `updated_at` が現在時刻に近い

---

### ステップ6: 🔄 **重要** Worker再起動シミュレーション
Workerは自動的に再起動することがあります。これをシミュレートします。

**方法A: 10分間待つ（推奨）**
- Cloudflare Workerは非アクティブ状態が続くと自動的にスリープします
- アプリケーションのタブを閉じる
- 10分間待つ
- 10分後、保存しておいたURL（セッションID付き）を開く

**方法B: Cloudflare Dashboardから強制再起動（上級者向け）**
- Cloudflare Dashboard → Pages → kobeyabkk-studypartner
- **Settings** → **Functions**
- **Rollback deployment** を実行して即座に再デプロイ
- または **Retry deployment** をクリック

**方法C: 新しいシークレットウィンドウで開く（簡易版）**
- ブラウザで新しいシークレット/プライベートウィンドウを開く
- 保存しておいたURL（セッションID付き）を貼り付けて開く
- これにより、サーバー側のメモリキャッシュがない状態をシミュレート

---

### ステップ7: セッション復元を確認
1. 保存しておいた **セッションID付きURL** を開く:
   ```
   https://kobeyabkk-studypartner.pages.dev/?session=abc123def456
   ```

2. **期待される結果**:
   - ✅ アップロードした画像が表示される
   - ✅ OCR結果のテキストが表示される
   - ✅ ステップ3でメモしたテキストと一致する
   - ✅ 「OCR処理を実行」ボタンではなく、「OCR結果を修正」ボタンが表示される

3. **❌ もし失敗した場合**:
   - 「セッションが見つかりません」エラーが表示される
   - 画像が表示されない
   - OCR結果が空になっている
   → この場合、D1からの復元に問題があります

---

### ステップ8: OCR修正機能をテスト
1. **「OCR結果を修正」** ボタンをクリック

2. テキストエリアが表示されるので、テキストを少し編集
   - 例: 「私は将来、医師になりたい」→「私は将来、優秀な医師になりたい」

3. **「修正を保存」** ボタンをクリック

4. **確認ポイント**:
   - ✅ 「修正が保存されました」というメッセージが表示される
   - ✅ 編集したテキストが反映されている

---

### ステップ9: 修正内容の永続化を確認
1. 再度、ステップ6のWorker再起動シミュレーションを実行

2. セッションID付きURLを開く

3. **期待される結果**:
   - ✅ 修正後のOCRテキストが表示される
   - ✅ ステップ8で編集した内容が保持されている

---

## 📊 テスト結果の記録

| テスト項目 | 結果 | 備考 |
|-----------|------|------|
| 画像アップロード | ⬜ 成功 / ⬜ 失敗 | |
| OCR処理実行 | ⬜ 成功 / ⬜ 失敗 | |
| D1にセッション保存 | ⬜ 成功 / ⬜ 失敗 | |
| Worker再起動後の復元 | ⬜ 成功 / ⬜ 失敗 | |
| OCRテキスト修正 | ⬜ 成功 / ⬜ 失敗 | |
| 修正内容の永続化 | ⬜ 成功 / ⬜ 失敗 | |

---

## 🐛 トラブルシューティング

### 問題1: 「セッションが見つかりません」エラー
**原因**: D1からセッションを読み込めていない

**確認方法**:
```sql
SELECT * FROM essay_sessions WHERE session_id = 'あなたのセッションID';
```

**解決策**:
- D1バインディングが正しく設定されているか確認
- `wrangler.toml` の `binding = "DB"` が正しいか確認
- Cloudflare Pagesの再デプロイを実行

---

### 問題2: 画像が表示されない
**原因**: `uploaded_images` データが保存されていない

**確認方法**:
```sql
SELECT session_data FROM essay_sessions WHERE session_id = 'あなたのセッションID';
```
→ `uploadedImages` フィールドに画像データがあるか確認

**解決策**:
- `saveSessionToDB()` 関数が正しく動作しているか確認
- ブラウザの開発者ツール（F12）→ Console タブでエラーを確認

---

### 問題3: OCR結果が消える
**原因**: `ocrResults` データが保存されていない

**確認方法**:
```sql
SELECT has_ocr_results, session_data FROM essay_sessions 
WHERE session_id = 'あなたのセッションID';
```

**解決策**:
- OCR処理後に `updateSession()` が呼ばれているか確認
- `session_data` JSONに `ocrResults` フィールドがあるか確認

---

## ✅ テスト成功の基準

以下すべてが満たされていれば **テスト成功** です：

1. ✅ 画像アップロード後、D1にセッションが保存される
2. ✅ OCR処理後、D1に結果が保存される
3. ✅ Worker再起動後も、セッションIDでアクセスすると画像・OCR結果が復元される
4. ✅ OCR修正内容がD1に保存される
5. ✅ 修正内容がWorker再起動後も保持される

---

## 📞 サポートが必要な場合

以下の情報を添えて質問してください：

1. **失敗したステップ番号**
2. **エラーメッセージ（スクリーンショット）**
3. **ブラウザの開発者ツールのConsoleタブ**（F12キーで開く）
4. **D1データベースのクエリ結果**

---

**作成日**: 2025-10-29  
**対象バージョン**: StudyPartner Full v1.0 (D1統合版)
